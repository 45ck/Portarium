openapi: 3.1.0
info:
  title: Portarium Control Plane API
  version: 1.0.0
  description: |
    Portarium is an API-first, multi-tenant control plane for governable business operations.

    This document defines the v1 HTTP contract for core control plane resources, starting with:
    - Workspaces (tenant boundary)
    - Workspace Users (RBAC)
    - Plan v1 and Evidence v1 schemas (used across Commands/Queries)
servers:
  - url: http://localhost:3000
tags:
  - name: Workspaces
  - name: Users
  - name: WorkItems
  - name: Plans
  - name: Evidence
  - name: Approvals
  - name: Workflows
  - name: Runs
  - name: CredentialGrants
  - name: AdapterRegistrations
  - name: Machines
  - name: Agents
paths:
  /v1/workspaces:
    get:
      tags: [Workspaces]
      summary: List workspaces visible to the caller
      operationId: listWorkspaces
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkspaceListResponse'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}:
    get:
      tags: [Workspaces]
      summary: Get a workspace
      operationId: getWorkspace
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Workspace'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/users:
    get:
      tags: [Users]
      summary: List users in a workspace
      operationId: listWorkspaceUsers
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Users]
      summary: Add a user to a workspace
      operationId: addWorkspaceUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddWorkspaceUserRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/users/{userId}:
    get:
      tags: [Users]
      summary: Get a workspace user
      operationId: getWorkspaceUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [Users]
      summary: Update a workspace user
      operationId: updateWorkspaceUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkspaceUserRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        default:
          $ref: '#/components/responses/Problem'
    delete:
      tags: [Users]
      summary: Remove a user from a workspace
      operationId: removeWorkspaceUser
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/UserIdPath'
      responses:
        '204':
          description: No Content
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/work-items:
    get:
      tags: [WorkItems]
      summary: List work items in a workspace
      operationId: listWorkItems
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkItemStatusQuery'
        - $ref: '#/components/parameters/WorkItemOwnerUserIdQuery'
        - $ref: '#/components/parameters/WorkItemRunIdQuery'
        - $ref: '#/components/parameters/WorkItemWorkflowIdQuery'
        - $ref: '#/components/parameters/WorkItemApprovalIdQuery'
        - $ref: '#/components/parameters/WorkItemEvidenceIdQuery'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItemListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [WorkItems]
      summary: Create a work item
      operationId: createWorkItem
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkItemRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItemV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/work-items/{workItemId}:
    get:
      tags: [WorkItems]
      summary: Get a work item
      operationId: getWorkItem
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkItemIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItemV1'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [WorkItems]
      summary: Update a work item
      operationId: updateWorkItem
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkItemIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkItemRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkItemV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/plans/{planId}:
    get:
      tags: [Plans]
      summary: Get a Plan (v1)
      operationId: getPlan
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/PlanIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PlanV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/evidence:
    get:
      tags: [Evidence]
      summary: List evidence entries (v1)
      operationId: listEvidenceEntries
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/EvidenceRunIdQuery'
        - $ref: '#/components/parameters/EvidencePlanIdQuery'
        - $ref: '#/components/parameters/EvidenceWorkItemIdQuery'
        - $ref: '#/components/parameters/EvidenceCategoryQuery'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidenceEntryListResponse'
        default:
          $ref: '#/components/responses/Problem'
  # ---- Approvals ----
  /v1/workspaces/{workspaceId}/approvals:
    get:
      tags: [Approvals]
      summary: List approvals in a workspace
      operationId: listApprovals
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Approvals]
      summary: Create an approval request
      operationId: createApproval
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateApprovalRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/approvals/{approvalId}:
    get:
      tags: [Approvals]
      summary: Get an approval
      operationId: getApproval
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/ApprovalIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/approvals/{approvalId}/decide:
    post:
      tags: [Approvals]
      summary: Decide on an approval (approve, deny, or request changes)
      operationId: decideApproval
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/ApprovalIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DecideApprovalRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalV1'
        default:
          $ref: '#/components/responses/Problem'
  # ---- Workflows ----
  /v1/workspaces/{workspaceId}/workflows:
    get:
      tags: [Workflows]
      summary: List workflows in a workspace
      operationId: listWorkflows
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Workflows]
      summary: Create a workflow
      operationId: createWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateWorkflowRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/workflows/{workflowId}:
    get:
      tags: [Workflows]
      summary: Get a workflow
      operationId: getWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkflowIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowV1'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [Workflows]
      summary: Update a workflow
      operationId: updateWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkflowIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateWorkflowRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WorkflowV1'
        default:
          $ref: '#/components/responses/Problem'
    delete:
      tags: [Workflows]
      summary: Archive a workflow
      operationId: archiveWorkflow
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/WorkflowIdPath'
      responses:
        '204':
          description: No Content
        default:
          $ref: '#/components/responses/Problem'
  # ---- Runs ----
  /v1/workspaces/{workspaceId}/runs:
    get:
      tags: [Runs]
      summary: List runs in a workspace
      operationId: listRuns
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Runs]
      summary: Start a new run
      operationId: startRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/StartRunRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/runs/{runId}:
    get:
      tags: [Runs]
      summary: Get a run
      operationId: getRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/runs/{runId}/cancel:
    post:
      tags: [Runs]
      summary: Cancel a run
      operationId: cancelRun
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/RunIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RunV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/runs/{runId}/evidence:
    get:
      tags: [Runs]
      summary: List evidence entries for a run
      operationId: listRunEvidence
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/RunIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/EvidenceEntryListResponse'
        default:
          $ref: '#/components/responses/Problem'
  # ---- Credential Grants ----
  /v1/workspaces/{workspaceId}/credential-grants:
    get:
      tags: [CredentialGrants]
      summary: List credential grants in a workspace
      operationId: listCredentialGrants
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [CredentialGrants]
      summary: Create a credential grant
      operationId: createCredentialGrant
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateCredentialGrantRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/credential-grants/{credentialGrantId}:
    get:
      tags: [CredentialGrants]
      summary: Get a credential grant
      operationId: getCredentialGrant
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/CredentialGrantIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantV1'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [CredentialGrants]
      summary: Update a credential grant
      operationId: updateCredentialGrant
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/CredentialGrantIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateCredentialGrantRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/credential-grants/{credentialGrantId}/rotate:
    post:
      tags: [CredentialGrants]
      summary: Rotate a credential grant
      operationId: rotateCredentialGrant
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/CredentialGrantIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/credential-grants/{credentialGrantId}/revoke:
    post:
      tags: [CredentialGrants]
      summary: Revoke a credential grant
      operationId: revokeCredentialGrant
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/CredentialGrantIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CredentialGrantV1'
        default:
          $ref: '#/components/responses/Problem'
  # ---- Adapter Registrations ----
  /v1/workspaces/{workspaceId}/adapter-registrations:
    get:
      tags: [AdapterRegistrations]
      summary: List adapter registrations in a workspace
      operationId: listAdapterRegistrations
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdapterRegistrationListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [AdapterRegistrations]
      summary: Create an adapter registration
      operationId: createAdapterRegistration
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateAdapterRegistrationRequest'
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdapterRegistrationV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/adapter-registrations/{adapterId}:
    get:
      tags: [AdapterRegistrations]
      summary: Get an adapter registration
      operationId: getAdapterRegistration
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/AdapterIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdapterRegistrationV1'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [AdapterRegistrations]
      summary: Update an adapter registration
      operationId: updateAdapterRegistration
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/AdapterIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAdapterRegistrationRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdapterRegistrationV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/machines:
    get:
      tags: [Machines]
      summary: List registered machine runtimes
      operationId: listMachines
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MachineListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Machines]
      summary: Register a machine runtime
      operationId: registerMachine
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterMachineRequest'
      responses:
        '201':
          description: Machine registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MachineV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/machines/{machineId}:
    get:
      tags: [Machines]
      summary: Get a machine runtime
      operationId: getMachine
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/MachineIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MachineV1'
        default:
          $ref: '#/components/responses/Problem'
    delete:
      tags: [Machines]
      summary: Deregister a machine runtime
      operationId: deregisterMachine
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/MachineIdPath'
      responses:
        '204':
          description: Deregistered
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/machines/{machineId}/test:
    post:
      tags: [Machines]
      summary: Smoke-test machine connectivity
      operationId: testMachineConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/MachineIdPath'
      responses:
        '200':
          description: Connection test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionTestResult'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/agents:
    get:
      tags: [Agents]
      summary: List AI agent configurations
      operationId: listAgents
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/LimitQuery'
        - $ref: '#/components/parameters/CursorQuery'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentListResponse'
        default:
          $ref: '#/components/responses/Problem'
    post:
      tags: [Agents]
      summary: Register an AI agent configuration
      operationId: registerAgent
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterAgentRequest'
      responses:
        '201':
          description: Agent registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/agents/{agentId}:
    get:
      tags: [Agents]
      summary: Get an AI agent configuration
      operationId: getAgent
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/AgentIdPath'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentV1'
        default:
          $ref: '#/components/responses/Problem'
    patch:
      tags: [Agents]
      summary: Update an AI agent configuration (capability allowlist, endpoint)
      operationId: updateAgent
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/AgentIdPath'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateAgentRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AgentV1'
        default:
          $ref: '#/components/responses/Problem'
  /v1/workspaces/{workspaceId}/agents/{agentId}/test:
    post:
      tags: [Agents]
      summary: Smoke-test AI agent endpoint connectivity
      operationId: testAgentConnection
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/WorkspaceIdPath'
        - $ref: '#/components/parameters/AgentIdPath'
      responses:
        '200':
          description: Connection test result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConnectionTestResult'
        default:
          $ref: '#/components/responses/Problem'
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    WorkspaceIdPath:
      name: workspaceId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/WorkspaceId'
    UserIdPath:
      name: userId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/UserId'
    PlanIdPath:
      name: planId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/PlanId'
    WorkItemIdPath:
      name: workItemId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/WorkItemId'
    ApprovalIdPath:
      name: approvalId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/ApprovalId'
    WorkflowIdPath:
      name: workflowId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/WorkflowId'
    RunIdPath:
      name: runId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/RunId'
    CredentialGrantIdPath:
      name: credentialGrantId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/CredentialGrantId'
    AdapterIdPath:
      name: adapterId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/AdapterId'
    MachineIdPath:
      name: machineId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/MachineId'
    AgentIdPath:
      name: agentId
      in: path
      required: true
      schema:
        $ref: '#/components/schemas/AgentId'
    LimitQuery:
      name: limit
      in: query
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 200
        default: 50
    CursorQuery:
      name: cursor
      in: query
      required: false
      schema:
        type: string
        minLength: 1
    WorkItemStatusQuery:
      name: status
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/WorkItemStatus'
    WorkItemOwnerUserIdQuery:
      name: ownerUserId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/UserId'
    WorkItemRunIdQuery:
      name: runId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/RunId'
    WorkItemWorkflowIdQuery:
      name: workflowId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/WorkflowId'
    WorkItemApprovalIdQuery:
      name: approvalId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/ApprovalId'
    WorkItemEvidenceIdQuery:
      name: evidenceId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/EvidenceId'
    EvidenceRunIdQuery:
      name: runId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/RunId'
    EvidencePlanIdQuery:
      name: planId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/PlanId'
    EvidenceWorkItemIdQuery:
      name: workItemId
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/WorkItemId'
    EvidenceCategoryQuery:
      name: category
      in: query
      required: false
      schema:
        $ref: '#/components/schemas/EvidenceCategory'
  responses:
    Problem:
      description: Error response
      content:
        application/problem+json:
          schema:
            $ref: '#/components/schemas/ProblemDetails'
  schemas:
    ProblemDetails:
      type: object
      additionalProperties: false
      properties:
        type:
          type: string
          format: uri
        title:
          type: string
        status:
          type: integer
          minimum: 100
          maximum: 599
        detail:
          type: string
        instance:
          type: string
          format: uri
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
      required: [type, title, status]
    IsoTimestamp:
      type: string
      format: date-time
      description: RFC3339 timestamp (UTC recommended)
    WorkspaceId:
      type: string
      minLength: 1
      description: Opaque workspace identifier (tenant boundary)
    UserId:
      type: string
      minLength: 1
      description: Opaque user identifier
    PlanId:
      type: string
      minLength: 1
      description: Opaque plan identifier
    RunId:
      type: string
      minLength: 1
      description: Opaque run identifier
    WorkItemId:
      type: string
      minLength: 1
      description: Opaque work item identifier
    ApprovalId:
      type: string
      minLength: 1
      description: Opaque approval identifier
    EvidenceId:
      type: string
      minLength: 1
      description: Opaque evidence entry identifier
    AdapterId:
      type: string
      minLength: 1
      description: Opaque adapter identifier
    MachineId:
      type: string
      minLength: 1
      description: Opaque machine identifier
    WorkflowId:
      type: string
      minLength: 1
      description: Opaque workflow identifier
    CorrelationId:
      type: string
      minLength: 1
      description: Opaque correlation identifier for traceability
    ActionId:
      type: string
      minLength: 1
      description: Opaque action identifier within a workflow
    CredentialGrantId:
      type: string
      minLength: 1
      description: Opaque credential grant identifier
    HashSha256:
      type: string
      pattern: '^[a-f0-9]{64}$'
      description: SHA-256 hex digest (lowercase)
    Workspace:
      type: object
      additionalProperties: false
      properties:
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        name:
          type: string
          minLength: 1
        createdAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required: [workspaceId, name, createdAtIso]
    WorkspaceListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/Workspace'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    UserRole:
      type: string
      enum: [admin, operator, approver, auditor]
    User:
      type: object
      additionalProperties: false
      properties:
        userId:
          $ref: '#/components/schemas/UserId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        email:
          type: string
          format: email
        displayName:
          type: string
          minLength: 1
        roles:
          type: array
          items:
            $ref: '#/components/schemas/UserRole'
          minItems: 1
          uniqueItems: true
        active:
          type: boolean
        createdAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required: [userId, workspaceId, email, roles, active, createdAtIso]
    UserListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/User'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    AddWorkspaceUserRequest:
      type: object
      additionalProperties: false
      properties:
        email:
          type: string
          format: email
        displayName:
          type: string
          minLength: 1
        roles:
          type: array
          items:
            $ref: '#/components/schemas/UserRole'
          minItems: 1
          uniqueItems: true
        active:
          type: boolean
          default: true
      required: [email, roles]
    UpdateWorkspaceUserRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        displayName:
          type: string
          minLength: 1
        roles:
          type: array
          items:
            $ref: '#/components/schemas/UserRole'
          minItems: 1
          uniqueItems: true
        active:
          type: boolean
    PortFamily:
      type: string
      enum:
        - FinanceAccounting
        - PaymentsBilling
        - ProcurementSpend
        - HrisHcm
        - Payroll
        - CrmSales
        - CustomerSupport
        - ItsmItOps
        - IamDirectory
        - SecretsVaulting
        - MarketingAutomation
        - AdsPlatforms
        - CommsCollaboration
        - ProjectsWorkMgmt
        - DocumentsEsign
        - AnalyticsBi
        - MonitoringIncident
        - ComplianceGrc
        - RoboticsActuation
    ExternalObjectRef:
      type: object
      additionalProperties: false
      properties:
        sorName:
          type: string
          minLength: 1
        portFamily:
          $ref: '#/components/schemas/PortFamily'
        externalId:
          type: string
          minLength: 1
        externalType:
          type: string
          minLength: 1
        displayLabel:
          type: string
          minLength: 1
        deepLinkUrl:
          type: string
          format: uri
      required: [sorName, portFamily, externalId, externalType]
    WorkItemStatus:
      type: string
      enum: [Open, Closed]
    WorkItemSlaV1:
      type: object
      additionalProperties: false
      properties:
        dueAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
    WorkItemLinksV1:
      type: object
      additionalProperties: false
      properties:
        externalRefs:
          type: array
          items:
            $ref: '#/components/schemas/ExternalObjectRef'
        runIds:
          type: array
          items:
            $ref: '#/components/schemas/RunId'
        workflowIds:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowId'
        approvalIds:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalId'
        evidenceIds:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceId'
    WorkItemV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        workItemId:
          $ref: '#/components/schemas/WorkItemId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        createdAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        createdByUserId:
          $ref: '#/components/schemas/UserId'
        title:
          type: string
          minLength: 1
        status:
          $ref: '#/components/schemas/WorkItemStatus'
        ownerUserId:
          $ref: '#/components/schemas/UserId'
        sla:
          $ref: '#/components/schemas/WorkItemSlaV1'
        links:
          $ref: '#/components/schemas/WorkItemLinksV1'
      required:
        - schemaVersion
        - workItemId
        - workspaceId
        - createdAtIso
        - createdByUserId
        - title
        - status
    WorkItemListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/WorkItemV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    CreateWorkItemRequest:
      type: object
      additionalProperties: false
      properties:
        title:
          type: string
          minLength: 1
        ownerUserId:
          $ref: '#/components/schemas/UserId'
        sla:
          $ref: '#/components/schemas/WorkItemSlaV1'
        externalRefs:
          type: array
          items:
            $ref: '#/components/schemas/ExternalObjectRef'
      required: [title]
    UpdateWorkItemRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        title:
          type: string
          minLength: 1
        status:
          $ref: '#/components/schemas/WorkItemStatus'
        ownerUserId:
          $ref: '#/components/schemas/UserId'
        sla:
          $ref: '#/components/schemas/WorkItemSlaV1'
        externalRefs:
          type: array
          items:
            $ref: '#/components/schemas/ExternalObjectRef'
    EffectOperation:
      type: string
      enum: [Create, Update, Delete, Upsert]
    PlannedEffectV1:
      type: object
      additionalProperties: false
      properties:
        effectId:
          type: string
          minLength: 1
        operation:
          $ref: '#/components/schemas/EffectOperation'
        target:
          $ref: '#/components/schemas/ExternalObjectRef'
        summary:
          type: string
          minLength: 1
        idempotencyKey:
          type: string
          minLength: 1
      required: [effectId, operation, target, summary]
    PredictedEffectV1:
      allOf:
        - $ref: '#/components/schemas/PlannedEffectV1'
        - type: object
          additionalProperties: false
          properties:
            confidence:
              type: number
              minimum: 0
              maximum: 1
    PlanV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        planId:
          $ref: '#/components/schemas/PlanId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        createdAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        createdByUserId:
          $ref: '#/components/schemas/UserId'
        plannedEffects:
          type: array
          items:
            $ref: '#/components/schemas/PlannedEffectV1'
        predictedEffects:
          type: array
          items:
            $ref: '#/components/schemas/PredictedEffectV1'
      required: [schemaVersion, planId, workspaceId, createdAtIso, createdByUserId, plannedEffects]
    EvidenceCategory:
      type: string
      enum: [Plan, Action, Approval, Policy, System]
    EvidenceActorUser:
      type: object
      additionalProperties: false
      properties:
        kind:
          type: string
          const: User
        userId:
          $ref: '#/components/schemas/UserId'
      required: [kind, userId]
    EvidenceActorMachine:
      type: object
      additionalProperties: false
      properties:
        kind:
          type: string
          const: Machine
        machineId:
          $ref: '#/components/schemas/MachineId'
      required: [kind, machineId]
    EvidenceActorAdapter:
      type: object
      additionalProperties: false
      properties:
        kind:
          type: string
          const: Adapter
        adapterId:
          $ref: '#/components/schemas/AdapterId'
      required: [kind, adapterId]
    EvidenceActorSystem:
      type: object
      additionalProperties: false
      properties:
        kind:
          type: string
          const: System
      required: [kind]
    EvidenceActor:
      oneOf:
        - $ref: '#/components/schemas/EvidenceActorUser'
        - $ref: '#/components/schemas/EvidenceActorMachine'
        - $ref: '#/components/schemas/EvidenceActorAdapter'
        - $ref: '#/components/schemas/EvidenceActorSystem'
      discriminator:
        propertyName: kind
        mapping:
          User: '#/components/schemas/EvidenceActorUser'
          Machine: '#/components/schemas/EvidenceActorMachine'
          Adapter: '#/components/schemas/EvidenceActorAdapter'
          System: '#/components/schemas/EvidenceActorSystem'
    EvidenceLinks:
      type: object
      additionalProperties: false
      properties:
        runId:
          $ref: '#/components/schemas/RunId'
        planId:
          $ref: '#/components/schemas/PlanId'
        workItemId:
          $ref: '#/components/schemas/WorkItemId'
        externalRefs:
          type: array
          items:
            $ref: '#/components/schemas/ExternalObjectRef'
      required: []
    EvidencePayloadKind:
      type: string
      enum: [Artifact, Snapshot, Diff, Log]
    EvidencePayloadRef:
      type: object
      additionalProperties: false
      properties:
        kind:
          $ref: '#/components/schemas/EvidencePayloadKind'
        uri:
          type: string
          minLength: 1
        contentType:
          type: string
          minLength: 1
        sha256:
          $ref: '#/components/schemas/HashSha256'
      required: [kind, uri]
    EvidenceEntryV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        evidenceId:
          $ref: '#/components/schemas/EvidenceId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        correlationId:
          $ref: '#/components/schemas/CorrelationId'
        occurredAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        category:
          $ref: '#/components/schemas/EvidenceCategory'
        summary:
          type: string
          minLength: 1
        actor:
          $ref: '#/components/schemas/EvidenceActor'
        links:
          $ref: '#/components/schemas/EvidenceLinks'
        payloadRefs:
          type: array
          items:
            $ref: '#/components/schemas/EvidencePayloadRef'
        previousHash:
          $ref: '#/components/schemas/HashSha256'
        hashSha256:
          $ref: '#/components/schemas/HashSha256'
      required:
        - schemaVersion
        - evidenceId
        - workspaceId
        - correlationId
        - occurredAtIso
        - category
        - summary
        - actor
        - hashSha256
    EvidenceEntryListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceEntryV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    # ---- Approval schemas ----
    ApprovalStatus:
      type: string
      enum: [Pending, Approved, Denied, RequestChanges]
    ApprovalV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        approvalId:
          $ref: '#/components/schemas/ApprovalId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        runId:
          $ref: '#/components/schemas/RunId'
        planId:
          $ref: '#/components/schemas/PlanId'
        workItemId:
          $ref: '#/components/schemas/WorkItemId'
        prompt:
          type: string
          minLength: 1
        status:
          $ref: '#/components/schemas/ApprovalStatus'
        requestedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        requestedByUserId:
          $ref: '#/components/schemas/UserId'
        assigneeUserId:
          $ref: '#/components/schemas/UserId'
        dueAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        decidedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        decidedByUserId:
          $ref: '#/components/schemas/UserId'
        rationale:
          type: string
          minLength: 1
      required:
        - schemaVersion
        - approvalId
        - workspaceId
        - runId
        - planId
        - prompt
        - status
        - requestedAtIso
        - requestedByUserId
    ApprovalListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ApprovalV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    CreateApprovalRequest:
      type: object
      additionalProperties: false
      properties:
        runId:
          $ref: '#/components/schemas/RunId'
        planId:
          $ref: '#/components/schemas/PlanId'
        workItemId:
          $ref: '#/components/schemas/WorkItemId'
        prompt:
          type: string
          minLength: 1
        assigneeUserId:
          $ref: '#/components/schemas/UserId'
        dueAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required: [runId, planId, prompt]
    DecideApprovalRequest:
      type: object
      additionalProperties: false
      properties:
        decision:
          type: string
          enum: [Approved, Denied, RequestChanges]
        rationale:
          type: string
          minLength: 1
      required: [decision, rationale]
    # ---- Workflow schemas ----
    ExecutionTier:
      type: string
      enum: [Auto, Assisted, HumanApprove, ManualOnly]
    WorkflowActionV1:
      type: object
      additionalProperties: false
      properties:
        actionId:
          $ref: '#/components/schemas/ActionId'
        order:
          type: integer
          minimum: 1
        portFamily:
          $ref: '#/components/schemas/PortFamily'
        operation:
          type: string
          minLength: 1
        executionTierOverride:
          $ref: '#/components/schemas/ExecutionTier'
      required: [actionId, order, portFamily, operation]
    WorkflowV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        workflowId:
          $ref: '#/components/schemas/WorkflowId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        name:
          type: string
          minLength: 1
        description:
          type: string
          minLength: 1
        version:
          type: integer
          minimum: 1
        active:
          type: boolean
        executionTier:
          $ref: '#/components/schemas/ExecutionTier'
        actions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowActionV1'
          minItems: 1
      required:
        - schemaVersion
        - workflowId
        - workspaceId
        - name
        - version
        - active
        - executionTier
        - actions
    WorkflowListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    CreateWorkflowRequest:
      type: object
      additionalProperties: false
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
          minLength: 1
        executionTier:
          $ref: '#/components/schemas/ExecutionTier'
        actions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowActionV1'
          minItems: 1
      required: [name, executionTier, actions]
    UpdateWorkflowRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        name:
          type: string
          minLength: 1
        description:
          type: string
          minLength: 1
        executionTier:
          $ref: '#/components/schemas/ExecutionTier'
        active:
          type: boolean
        actions:
          type: array
          items:
            $ref: '#/components/schemas/WorkflowActionV1'
          minItems: 1
    # ---- Run schemas ----
    RunStatus:
      type: string
      enum: [Pending, Running, WaitingForApproval, Paused, Succeeded, Failed, Cancelled]
    RunV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        runId:
          $ref: '#/components/schemas/RunId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        workflowId:
          $ref: '#/components/schemas/WorkflowId'
        correlationId:
          $ref: '#/components/schemas/CorrelationId'
        executionTier:
          $ref: '#/components/schemas/ExecutionTier'
        initiatedByUserId:
          $ref: '#/components/schemas/UserId'
        status:
          $ref: '#/components/schemas/RunStatus'
        createdAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        startedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        endedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required:
        - schemaVersion
        - runId
        - workspaceId
        - workflowId
        - correlationId
        - executionTier
        - initiatedByUserId
        - status
        - createdAtIso
    RunListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/RunV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    StartRunRequest:
      type: object
      additionalProperties: false
      properties:
        workflowId:
          $ref: '#/components/schemas/WorkflowId'
        parameters:
          type: object
      required: [workflowId]
    # ---- Credential Grant schemas ----
    CredentialGrantV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        credentialGrantId:
          $ref: '#/components/schemas/CredentialGrantId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        adapterId:
          $ref: '#/components/schemas/AdapterId'
        credentialsRef:
          type: string
          minLength: 1
        scope:
          type: string
          minLength: 1
        issuedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        expiresAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        lastRotatedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
        revokedAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required:
        - schemaVersion
        - credentialGrantId
        - workspaceId
        - adapterId
        - credentialsRef
        - scope
        - issuedAtIso
    CredentialGrantListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/CredentialGrantV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    CreateCredentialGrantRequest:
      type: object
      additionalProperties: false
      properties:
        adapterId:
          $ref: '#/components/schemas/AdapterId'
        credentialsRef:
          type: string
          minLength: 1
        scope:
          type: string
          minLength: 1
        expiresAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
      required: [adapterId, credentialsRef, scope]
    UpdateCredentialGrantRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        scope:
          type: string
          minLength: 1
        expiresAtIso:
          $ref: '#/components/schemas/IsoTimestamp'
    # ---- Adapter Registration schemas ----
    CapabilityClaimV1:
      type: object
      additionalProperties: false
      description: >-
        A single capability claim declared by an adapter.  The capability field
        uses the portFamily:operation pattern (e.g. FinanceAccounting:invoice:read).
      properties:
        capability:
          type: string
          pattern: '^[A-Za-z]+:[a-z][a-z0-9_]*:[a-z][a-z0-9_]*$'
          description: Port-family capability string (portFamily:noun:verb).
        operation:
          type: string
          minLength: 1
          description: Human-readable operation name (may differ from capability slug).
        requiresAuth:
          type: boolean
          description: Whether invoking this capability requires credential injection.
        inputKind:
          type: string
          minLength: 1
          description: Optional canonical input object kind.
        outputKind:
          type: string
          minLength: 1
          description: Optional canonical output object kind.
      required: [operation, requiresAuth]
    AdapterMachineEntryV1:
      type: object
      additionalProperties: false
      description: A machine runtime registered under an adapter.
      properties:
        machineId:
          $ref: '#/components/schemas/MachineId'
        endpointUrl:
          type: string
          format: uri
        active:
          type: boolean
        displayName:
          type: string
          minLength: 1
        authHint:
          type: string
          minLength: 1
          description: Optional hint for credential lookup (vault path or grant reference).
      required: [machineId, endpointUrl, active]
    AdapterExecutionPolicyV1:
      type: object
      additionalProperties: false
      properties:
        tenantIsolationMode:
          type: string
          const: PerTenantWorker
          description: Enforces per-tenant worker isolation for adapter execution.
        egressAllowlist:
          type: array
          minItems: 1
          items:
            type: string
            format: uri
            pattern: '^https://'
          description: Explicit egress allowlist for adapter runtime outbound calls.
        credentialScope:
          type: string
          const: capabilityMatrix
          description: Credentials are scoped to declared capability matrix operations.
        sandboxVerified:
          type: boolean
          const: true
          description: Sandbox availability was verified during registration.
        sandboxAvailable:
          type: boolean
          description: Provider exposes a sandbox/test environment.
      required:
        - tenantIsolationMode
        - egressAllowlist
        - credentialScope
        - sandboxVerified
        - sandboxAvailable
    AdapterRegistrationV1:
      type: object
      additionalProperties: false
      properties:
        schemaVersion:
          type: integer
          const: 1
        adapterId:
          $ref: '#/components/schemas/AdapterId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        providerSlug:
          type: string
          minLength: 1
          description: Unique provider identifier slug (e.g. 'quickbooks', 'netsuite').
        portFamily:
          $ref: '#/components/schemas/PortFamily'
        enabled:
          type: boolean
        executionPolicy:
          $ref: '#/components/schemas/AdapterExecutionPolicyV1'
        capabilityMatrix:
          type: array
          items:
            $ref: '#/components/schemas/CapabilityClaimV1'
          description: >-
            Declared capabilities for this adapter.  Must contain at least one
            entry; controls which operations the adapter may perform within the
            port family.
        machineRegistrations:
          type: array
          items:
            $ref: '#/components/schemas/AdapterMachineEntryV1'
          description: >-
            Machine runtimes associated with this adapter (optional).
            Populated when the adapter delegates execution to an agent runtime.
      required:
        - schemaVersion
        - adapterId
        - workspaceId
        - providerSlug
        - portFamily
        - enabled
        - executionPolicy
        - capabilityMatrix
    AdapterRegistrationListResponse:
      type: object
      additionalProperties: false
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AdapterRegistrationV1'
        nextCursor:
          type: string
          minLength: 1
      required: [items]
    CreateAdapterRegistrationRequest:
      type: object
      additionalProperties: false
      properties:
        providerSlug:
          type: string
          minLength: 1
        portFamily:
          $ref: '#/components/schemas/PortFamily'
        enabled:
          type: boolean
          default: true
        executionPolicy:
          $ref: '#/components/schemas/AdapterExecutionPolicyV1'
        capabilityMatrix:
          type: array
          items:
            $ref: '#/components/schemas/CapabilityClaimV1'
          minItems: 1
      required: [providerSlug, portFamily, executionPolicy, capabilityMatrix]
    UpdateAdapterRegistrationRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        providerSlug:
          type: string
          minLength: 1
        enabled:
          type: boolean
        executionPolicy:
          $ref: '#/components/schemas/AdapterExecutionPolicyV1'
        capabilityMatrix:
          type: array
          items:
            $ref: '#/components/schemas/CapabilityClaimV1'
          minItems: 1
    AgentId:
      type: string
      minLength: 1
    AgentCapability:
      type: string
      enum:
        - read:external
        - write:external
        - classify
        - generate
        - analyze
        - execute-code
        - notify
    ConnectionTestStatus:
      type: string
      enum: [ok, slow, unreachable]
    ConnectionTestResult:
      type: object
      additionalProperties: false
      required: [status, latencyMs]
      properties:
        status:
          $ref: '#/components/schemas/ConnectionTestStatus'
        latencyMs:
          type: integer
          minimum: 0
        errorMessage:
          type: string
    MachineStatus:
      type: string
      enum: [Online, Degraded, Offline]
    MachineV1:
      type: object
      additionalProperties: false
      required: [schemaVersion, machineId, workspaceId, hostname, registeredAtIso, status]
      properties:
        schemaVersion:
          type: integer
          const: 1
        machineId:
          $ref: '#/components/schemas/MachineId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        hostname:
          type: string
          minLength: 1
        osImage:
          type: string
        registeredAtIso:
          type: string
          format: date-time
        lastHeartbeatAtIso:
          type: string
          format: date-time
        status:
          $ref: '#/components/schemas/MachineStatus'
        activeRunCount:
          type: integer
          minimum: 0
        allowedCapabilities:
          type: array
          items:
            $ref: '#/components/schemas/AgentCapability'
    MachineListResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/MachineV1'
        nextCursor:
          type: string
    RegisterMachineRequest:
      type: object
      additionalProperties: false
      required: [hostname]
      properties:
        hostname:
          type: string
          minLength: 1
        osImage:
          type: string
        allowedCapabilities:
          type: array
          items:
            $ref: '#/components/schemas/AgentCapability'
    AgentV1:
      type: object
      additionalProperties: false
      required: [schemaVersion, agentId, workspaceId, name, endpoint, allowedCapabilities]
      properties:
        schemaVersion:
          type: integer
          const: 1
        agentId:
          $ref: '#/components/schemas/AgentId'
        workspaceId:
          $ref: '#/components/schemas/WorkspaceId'
        name:
          type: string
          minLength: 1
        modelId:
          type: string
        endpoint:
          type: string
          format: uri
        allowedCapabilities:
          type: array
          items:
            $ref: '#/components/schemas/AgentCapability'
        usedByWorkflowIds:
          type: array
          items:
            type: string
    AgentListResponse:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/AgentV1'
        nextCursor:
          type: string
    RegisterAgentRequest:
      type: object
      additionalProperties: false
      required: [name, endpoint]
      properties:
        name:
          type: string
          minLength: 1
        modelId:
          type: string
        endpoint:
          type: string
          format: uri
        allowedCapabilities:
          type: array
          items:
            $ref: '#/components/schemas/AgentCapability'
    UpdateAgentRequest:
      type: object
      additionalProperties: false
      minProperties: 1
      properties:
        name:
          type: string
          minLength: 1
        endpoint:
          type: string
          format: uri
        allowedCapabilities:
          type: array
          items:
            $ref: '#/components/schemas/AgentCapability'
