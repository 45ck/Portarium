# ADR-0081: Token Refresh and Rotation Strategy

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0328

## Context

Portarium issues and consumes two categories of bearer token:

| Category              | Issuer                                  | Lifetime  | Consumers                                   |
| --------------------- | --------------------------------------- | --------- | ------------------------------------------- |
| User access token     | External IdP (Keycloak / Entra / Auth0) | 15–60 min | UI, API clients                             |
| Machine / agent token | Internal Portarium auth service         | 5–60 min  | Execution-plane workers, adapter connectors |

Token compromise is a high-severity event. We need policies for:

1. **Access token rotation** — how short-lived tokens are renewed without re-authentication
2. **Refresh token rotation** — preventing refresh token reuse attacks
3. **Key rotation** — rotating the signing keys used to issue tokens
4. **Revocation** — invalidating tokens before their natural expiry

## Decisions

### 1. Access token lifetime

- **User tokens**: 15-minute access token TTL. Long enough to avoid excessive refresh round-trips; short enough to limit the window of opportunity after compromise.
- **Machine/agent tokens**: 5-minute TTL. Execution-plane workers are high-risk (external calls, tenant data); short-lived tokens reduce blast radius.
- **Clock tolerance**: ≤ 30 seconds. Set via `JoseJwtAuthenticationConfig.clockToleranceSeconds`. Prevents clock-skew false rejections without opening a long-lived attack window.

### 2. Refresh token rotation (for user sessions)

Adopt **refresh token rotation with reuse detection** (OAuth 2.0 Security Best Practices §2.2.2):

- Each use of a refresh token issues a **new** refresh token and invalidates the previous one.
- If a refresh token is presented that has already been used, **invalidate the entire token family** (the whole session) — this signals that the original token was stolen.
- Refresh tokens have a 30-day absolute expiry and a 7-day idle expiry.
- Refresh tokens are stored hashed in the database; only the hash is persisted.

### 3. Key rotation for machine tokens

- Portarium internal signing keys (RS256, 2048-bit minimum / ES256) are rotated **every 90 days**.
- JWKS endpoint exposes both the current key and the previous key for a 24-hour overlap period.
- `kid` (Key ID) is mandatory in all token headers so verifiers can select the correct key.
- New key generation is a zero-downtime operation: publish the new public key to JWKS before signing with the new private key.

### 4. Revocation

Portarium does not implement a full token revocation endpoint (introspection would add latency to every request). Instead:

- **Short TTLs** are the primary revocation mechanism.
- **Signed-out session blocklist**: a Redis set stores `(sub, jti)` pairs for tokens issued in the last 60 minutes to users who have explicitly signed out. The blocklist check is ≤ 1 ms.
- Machine tokens are not revocable mid-flight; when a connector is decommissioned, its Vault role is revoked which prevents new token issuance within the next TTL window.

### 5. `azp` and `iss` enforcement in production

`JoseJwtAuthentication` is configured at startup with:

- `issuer` set to the primary IdP issuer URL
- `trustedIssuers` set to all configured federated IdPs
- `authorizedParty` set to the expected `client_id` for each service
- `requiredTokenType: "at+JWT"` for all new issuances (legacy `"JWT"` accepted during migration)
- `audience` set to `"portarium-api"` (or the appropriate service audience)

These values are injected via environment variables at deploy time and validated at startup.

## Consequences

- Administrators must provision a Redis instance for the signed-out session blocklist.
- The execution-plane requires Vault Secrets Operator (see ADR bead-0327) to obtain short-lived machine tokens without long-lived static secrets.
- A `KeyRotationScheduled` domain event must be emitted 14 days before key rotation to allow downstream consumers to update their JWKS cache.
- `JoseJwtAuthentication` tests now validate `azp`, `trustedIssuers`, and `typ` — these must be kept green with every IdP configuration change.
