# ADR-0091: OTel Collector Production Pipeline

**Status:** Accepted
**Date:** 2026-02-22
**Bead:** bead-0428

## Context

The existing OTel Collector configuration exported all signals (traces, metrics, logs)
only to a local `logging` exporter, making it unusable for production observability.
There were placeholder comments for Tempo and Prometheus but no working configuration,
and no log backend at all.

Additionally, there was no cross-signal correlation: metrics dashboards could not
link to individual traces, and log entries could not be pivoted to their originating span.

## Decision

Upgrade the OTel Collector pipeline to a full production configuration:

### Signal backends

| Signal  | Backend                                    | Protocol  |
| ------- | ------------------------------------------ | --------- |
| Traces  | Grafana Tempo                              | OTLP/gRPC |
| Metrics | Prometheus remote-write (Mimir-compatible) | HTTP      |
| Logs    | Grafana Loki                               | OTLP/HTTP |

### Cross-signal correlation

Three mechanisms link signals together in Grafana:

1. **spanmetrics connector** — derives `portarium_trace_*` RED metrics (rate, errors,
   duration histogram) from trace spans. Grafana exemplars on these metrics include the
   `trace_id`, enabling a single click from a metrics spike to the causative trace.

2. **servicegraph connector** — derives service-dependency graph metrics so Grafana's
   service map panel can show request flow between microservices.

3. **trace_id label in Loki** — the OTel Collector propagates `trace_id` as a structured
   metadata field on log records. Grafana's Loki datasource can derive a Tempo link from
   this field, enabling log-to-trace pivots.

### Tail sampling

To control Tempo storage costs while keeping full observability on errors:

- 100 % of error spans are retained
- 100 % of spans from traces with p99 latency > 1 s are retained
- 5 % base-rate sampling for all other healthy traces

### Security

- All backend connections use TLS (CA from `otel-tls-ca` Secret)
- Auth tokens from `otel-backends` Secret (never in ConfigMap)
- PII redaction processor removes `user.email`, `user.ip`, `db.statement`
- `tenant.id` is hashed (SHA-256) to allow cross-signal joins without exposing raw IDs

### Alerting

Self-monitoring alerts in `infra/otel/alerts/otel-pipeline-alerts.yaml`:

- Exporter dropping spans/metrics/logs (warning)
- Export queue > 80% full (warning)
- Collector memory > 400 MiB (warning)
- Collector down (critical)
- spanmetrics connector stalled (warning)

## Consequences

- Grafana can display unified dashboards with metrics, traces, and logs for any
  service without context switching.
- Tail sampling reduces Tempo storage by ~95 % vs. full sampling while retaining
  all actionable traces.
- The OTel Collector is now a critical infrastructure component; the 2-replica
  deployment with topology spread constraints and PDB (from bead-0396) ensures HA.
- Backend credentials must be provisioned in the `otel-backends` Secret before deployment.
