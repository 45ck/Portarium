# ADR-0082: Artefact Promotion Strategy — Git-SHA Pinning and Approval Gates

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0387

## Context

Portarium operates across four environments (`local`, `dev`, `staging`, `prod`).
Container images built on `main` must be reliably promoted through each tier without
the risk of a "works on dev, breaks on prod" class of failures caused by different
image content reaching different environments.

Two deficiencies existed in the baseline:

1. **Mutable image tags**: Kustomize overlays referenced tags like `dev-latest`,
   `staging-latest`, `prod-latest`. These tags can be overwritten by any new image
   build, making it impossible to audit or guarantee which content runs in each
   environment.

2. **Manual-only promotion**: `cd-k8s-deploy.yml` is triggered entirely by
   `workflow_dispatch`. There was no automated path from a successful CI build to a
   dev deployment, and no formal approval gate between environments.

We considered three strategies:

| Strategy                                    | How image identity is tracked | Promotion automation                                   |
| ------------------------------------------- | ----------------------------- | ------------------------------------------------------ |
| **A. Mutable floating tags** (`dev-latest`) | None — tag is overwritten     | Manual; no audit trail                                 |
| **B. Git-SHA tags** (`<40-char-sha>`)       | Git history                   | Automatic to dev; manual gates for staging/prod        |
| **C. Image digest pinning** (`@sha256:...`) | Registry digest               | Automatic to dev; manual gates; requires digest lookup |

Strategy C provides the strongest immutability guarantee (the digest is a content
hash, independent of tag), but it requires a registry API call during the promotion
workflow to resolve the digest from the SHA tag. Strategy B achieves equivalent
practical immutability because the git SHA is a unique, non-reusable identifier and
the CI build tags images with that SHA at build time.

## Decision

Adopt **Strategy B: git-SHA tag pinning** for the initial promotion pipeline.

### 1. Image tagging (no change to `ci-images.yml` required)

`ci-images.yml` already tags images with the git SHA:

```
ghcr.io/<org>/portarium-<component>:<git-sha>
ghcr.io/<org>/portarium-<component>:sha-<git-sha>
```

These tags are immutable in practice: a different commit produces a different SHA.
The `sha-` prefix tag is a human-readable equivalent; the bare SHA tag is used
for automation.

### 2. Kustomize overlay management

The `images[].newTag` field in each environment's Kustomize overlay is the single
point where the promoted SHA is recorded:

```yaml
# infra/kubernetes/overlays/dev/kustomization.yaml
images:
  - name: ghcr.io/your-org/portarium-control-plane
    newTag: <git-sha>
  - name: ghcr.io/your-org/portarium-worker
    newTag: <git-sha>
```

This file is committed to `main` and serves as the **deployment audit log** — the
git history of these files shows which SHA was active in each environment and when.

### 3. Promotion workflow

A new workflow `cd-promote.yml` implements the promotion pipeline:

**Automatic dev promotion** (on successful `CI (Container Images)` on `main`):

- Trigger: `workflow_run` on `CI (Container Images)` completing with `success`.
- Action: update `infra/kubernetes/overlays/dev/kustomization.yaml` with the new SHA
  and commit to `main`.
- No human approval required.

**Manual staging/prod promotion** (via `workflow_dispatch`):

- Trigger: operator dispatches the workflow with `target_environment` and optional
  `image_sha` input.
- Action: update the target overlay and commit after the GitHub environment protection
  rule is satisfied.
- **Staging**: 1 reviewer required.
- **Prod**: 2 reviewers required.

The workflow uses `kustomize edit set image` to update the overlay, which is safe
to run idempotently (no-op if the SHA is already pinned).

### 4. GitHub environment protection configuration

GitHub repository settings must be configured with:

| Environment | Required reviewers | Deployment branches |
| ----------- | ------------------ | ------------------- |
| `dev`       | 0 (automatic)      | `main`              |
| `staging`   | 1                  | `main`              |
| `prod`      | 2                  | `main`              |

These settings are enforced by GitHub when any workflow job references
`environment: staging` or `environment: prod`.

### 5. Deployment (unchanged)

`cd-k8s-deploy.yml` remains the mechanism for applying manifests to clusters.
It verifies image provenance (Sigstore signature + SBOM attestation) before
applying. Promotion (overlay update) and deployment (cluster apply) remain
separate steps — this matches the GitOps model where the overlay update is the
source of truth and deployment is a reconciliation step.

### 6. Rollback

Rolling back is a promotion in reverse: dispatch `cd-promote.yml` with the
target environment and the previous good SHA as `image_sha`. The overlay is
updated to the old SHA, and `cd-k8s-deploy.yml` is run to reconcile the cluster.

## Consequences

**Positive:**

- Every deployed SHA is recorded in git history; audit trail is free.
- Promotion to dev is fully automated; operators focus on staging/prod gates.
- Image immutability is guaranteed at the workflow level without requiring digest
  resolution.
- Rollback is a first-class, audited operation via the same promotion workflow.

**Negative / Trade-offs:**

- A 40-character SHA tag in `kustomization.yaml` is less human-readable than a
  semantic version. Operators must use `git log` to map a SHA to a PR or commit
  message.
- This strategy does not guard against a SHA tag being force-overwritten in the
  registry. Digest pinning (Strategy C) would prevent this, but requires registry
  API integration that is deferred to a future bead.
- Two separate steps (promote → deploy) mean a cluster can be transiently out of
  sync with the overlay if `cd-k8s-deploy.yml` is not run after promotion. This
  is the accepted trade-off until Flux or ArgoCD is introduced (future bead).
