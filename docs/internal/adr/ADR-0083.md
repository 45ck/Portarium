# ADR-0083: Environment Model and Artefact Promotion Pipeline

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0387

## Context

Portarium requires a clear, auditable promotion path from developer commit to
production deployment. Without a formal model, environment differences are
scattered across ad-hoc scripts and tribal knowledge.

Requirements:

1. Three canonical environments: **dev**, **staging**, **prod**.
2. Immutable artefact promotion — the same container image digest is deployed
   to each successive environment. There are no environment-specific builds.
3. Per-environment configuration differences are declared, not scripted.
4. Production deployments require human approval and provenance/security gates.
5. The environment model is machine-readable for tooling and audits.

## Decision

### Environment manifest format

Each environment is described by a JSON manifest at
`infra/environments/<env>.json` conforming to `environment-schema.json`.

The manifest captures:

- Promotion chain (`source` / `target`)
- Kubernetes overlay path
- Terraform tfvars path and backend state key
- Non-secret application config values
- Scaling parameters
- Database resilience settings
- Gate requirements (`requireCiGreen`, `requireProvenance`, `requireSecurityScan`)

### Environment definitions

| Property            | dev            | staging        | prod             |
| ------------------- | -------------- | -------------- | ---------------- |
| Tier                | non-production | non-production | production       |
| Auto-promote        | yes            | no             | no               |
| Approval required   | no             | yes            | yes              |
| Multi-AZ DB         | no             | yes            | yes              |
| Deletion protection | no             | yes            | yes              |
| Backup retention    | 7 days         | 14 days        | 35 days          |
| Provenance gate     | no             | yes            | yes              |
| Security scan gate  | no             | yes            | yes              |
| Evidence retention  | 30 days        | 365 days       | 2555 days (7 yr) |
| Log level           | debug          | info           | warn             |

### Promotion pipeline (`cd-promote.yml`)

```
push to main
    │
    ▼
ci.yml → build + test + scan (ci-images.yml)
    │
    ▼
deploy to DEV (auto, no approval)
    │
    ▼ (manual trigger or auto on success)
staging gates: provenance verify + Trivy scan
    │
    ▼ (GitHub Environment approval: staging)
deploy to STAGING
    │
    ▼ (manual trigger)
prod gates: provenance verify + Trivy scan
    │
    ▼ (GitHub Environment approval: prod)
deploy to PROD
```

The `cd-promote.yml` workflow accepts a `source_environment` + `commit_sha`
pair. It resolves the target from the environment manifest, runs the configured
gates, waits for the GitHub Environment approval (if required), then applies the
Kubernetes manifest with the pinned image tag `sha-<commit_sha>`.

### Non-secret configuration injection

Non-secret values from `infra/environments/<env>.json#config` are injected at
deploy time as Kubernetes ConfigMap patches or Helm value overrides. Secret
values (DB passwords, API keys) are never stored in environment manifests —
they are retrieved from Vault at runtime via the Vault Secrets Operator
(ADR bead-0327).

## Consequences

- All environment differences MUST be expressed in `infra/environments/*.json`
  — no ad-hoc per-environment scripting.
- New feature flags must be added to all three environment manifests before
  release.
- Adding a fourth environment requires only a new JSON manifest + GitHub
  Environment configuration.
- The `environment-schema.json` is the contract; changes to it constitute a
  breaking change and must be coordinated with all environment manifests.
