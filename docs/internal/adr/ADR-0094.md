# ADR-0094: Cockpit Mobile Delivery — PWA-First + Capacitor iOS/Android

**Status:** Accepted
**Date:** 2026-02-22
**Bead:** bead-0714 (campaign parent)
**Child beads:** bead-0719 (PWA), bead-0720 (Capacitor), bead-0721 (OIDC auth), bead-0722 (push), bead-0723 (release hardening)

---

## Context

Portarium Cockpit is a React/Vite SPA used by operations teams for robot fleet monitoring and mission control. Field operators increasingly use mobile devices (iOS/Android) while on-site. The current desktop-first experience has three friction points on mobile:

1. **Not installable** — no service worker, no Add to Home Screen prompt.
2. **Auth unsuitable for mobile** — current OIDC redirect relies on desktop browser session continuity; mobile browsers lose state on background-kill.
3. **No native notifications** — operators miss mission alerts when the browser tab is not visible.

The mobile campaign closes these gaps with a two-track strategy:

- **Track A (PWA):** installable Progressive Web App with service worker, offline shell, and web push.
- **Track B (Capacitor):** thin native wrapper on top of the existing React app for App Store distribution, deep links, secure credential storage, and APNs/FCM push.

---

## Decision

### Architecture

```
┌─────────────────────────────────────────────────┐
│                React SPA (shared)                │
│  apps/cockpit/src/ — no Capacitor imports here  │
└───────────────┬────────────────┬────────────────┘
                │                │
        ┌───────▼──────┐  ┌─────▼──────────┐
        │  PWA / SW    │  │ Capacitor shell │
        │ (web browser)│  │  (iOS/Android) │
        └──────────────┘  └────────────────┘
```

The React SPA contains **zero** direct Capacitor imports. A thin
`src/lib/native-bridge.ts` module detects the runtime environment and
delegates to either the Web API or the `@capacitor/*` plugin.

### PWA (bead-0719)

- `vite-plugin-pwa` (Workbox) generates the service worker.
- Precache: `index.html` + critical JS/CSS bundles.
- Runtime cache: navigation (network-first), API (`/api/**`) — network-first with 3s timeout fallback to cached stale response.
- `site.webmanifest` already present; extend with `screenshots[]` and `shortcuts[]`.

### Capacitor (bead-0720)

- `@capacitor/core` + `@capacitor/ios` + `@capacitor/android` wrappers around the existing build output.
- `capacitor.config.ts` at repo root (`apps/cockpit/`) pointing `webDir` at `dist/`.
- Platform-specific CI jobs: `npx cap run ios` (macOS runner), `npx cap run android` (Linux runner).

### Auth (bead-0721)

- OIDC PKCE flow via `@capacitor/browser` (in-app browser) on native; standard `window.location` redirect on web.
- Token storage: `@capacitor/preferences` (Keychain/Keystore backed) on native; `sessionStorage` on web.
- Refresh token rotation with silent renew via hidden `<iframe>` on web; background-safe token exchange on native.

### Push notifications (bead-0722)

- Web: Push API + VAPID keys via `notifications-api` package.
- Native: `@capacitor/push-notifications` → APNs (iOS) / FCM (Android).
- Backend: push registration endpoint stores device token; notification fanout triggered by `MissionFailed` / approval-pending CloudEvents.

### Release hardening (bead-0723)

- iOS: Fastlane `gym` + TestFlight upload.
- Android: Gradle release build + Play Internal Testing track.
- PWA: Lighthouse CI threshold ≥90 PWA score in `ci:nightly`.

---

## Implementation order

| Bead      | Deliverable                       | Blocking   |
| --------- | --------------------------------- | ---------- |
| bead-0719 | Installable PWA (SW + manifest)   | —          |
| bead-0721 | OIDC PKCE mobile auth             | —          |
| bead-0720 | Capacitor iOS/Android wrapper     | 0719, 0721 |
| bead-0722 | Push pipeline (APNs/FCM/Web Push) | 0720       |
| bead-0723 | CI builds + store submission      | 0720, 0722 |

---

## Alternatives Considered

### React Native rewrite

Rejected. Maintains a separate codebase; duplicates all business logic. The PWA + Capacitor approach reuses 100% of the existing React SPA.

### Ionic Framework

Considered. Ionic provides a Capacitor integration but also an opinionated UI component set. Portarium Cockpit already uses shadcn/ui + Tailwind; migrating to Ionic components was assessed as higher risk than the Capacitor-only wrapper.

### Web-only (no App Store)

Accepted as fallback for operators who prefer the browser. App Store distribution is additive; the PWA remains the primary delivery channel.

---

## Consequences

**Positive**

- Field operators can install Cockpit on iOS/Android in < 3 minutes.
- Mission alerts are delivered even when the app is backgrounded.
- Single codebase for web + iOS + Android.

**Negative / trade-offs**

- App Store review adds 1–3 day delay per release.
- Capacitor native build requires macOS CI runner for iOS.
- Push notification infrastructure requires a backend token registry.
