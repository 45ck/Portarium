# ADR-0093: mTLS Workload Identity for Robot Gateways via SPIFFE/SPIRE

**Status:** Accepted
**Date:** 2026-02-22
**Bead:** bead-0521
**Supersedes:** *(none)*
**Related:** ADR-0070 (hybrid orchestration), ADR-0092 (SROS2 hardening), ADR-0087 (gRPC mission gateway), ADR-0088 (MQTT mission gateway)

---

## Context

Portarium robot gateway adapters (gRPC, MQTT, OPC UA, ROS 2 bridge) connect to external services and robots over networks that may be partially untrusted. Without workload identity:

- Gateway credentials are long-lived static files or environment variables (hard to rotate).
- No strong attestation that a credential was issued to the exact workload running in the expected Kubernetes pod.
- Certificate rotation requires manual intervention.

SPIFFE (Secure Production Identity Framework for Everyone) provides a standard API for workloads to obtain short-lived X.509 certificates (SVIDs) that prove their identity without secret distribution.

SPIRE (SPIFFE Runtime Environment) is the reference implementation of the SPIFFE spec; it includes a Kubernetes-native node attestor (PSAT) and a workload API served via a Unix domain socket co-located with each pod.

---

## Decision

Deploy SPIRE Server (StatefulSet) and SPIRE Agent (DaemonSet) in the `spire` namespace. Use the SPIFFE Workload API to issue X.509 SVIDs to all robotics gateway pods.

### SVID issuance

| Component | SPIFFE ID template |
|-----------|-------------------|
| robotics-gateway | `spiffe://portarium.robotics/ns/<ns>/sa/robotics-gateway/<pod>` |
| control-plane | `spiffe://portarium.robotics/ns/<ns>/sa/control-plane/<pod>` |
| execution-plane | `spiffe://portarium.robotics/ns/<ns>/sa/execution-plane/<pod>` |

SVID TTL: **1 hour** (renew 5 minutes before expiry via `fetchSVID()` helper).

### Node attestation

SPIRE agents use the Kubernetes Projected Service Account Token (PSAT) attestor. This provides cryptographic proof that the agent is running on a specific Kubernetes node, bound to a specific service account, without requiring a pre-shared secret.

Allowed service accounts for SPIRE agent attestation:
- `spire:spire-agent`
- `portarium:robotics-gateway`

### Integration with gRPC/mTLS

The `fetchSVID()` helper (`src/infrastructure/adapters/robotics-gateway/spiffe-workload-credential.ts`) returns a short-lived X.509 credential that can be passed directly to gRPC `ChannelCredentials.createSsl()`:

```typescript
const svid = await fetchSVID();
const creds = grpc.ChannelCredentials.createSsl(
  Buffer.from(svid.bundlePem),
  Buffer.from(svid.keyPem),
  Buffer.from(svid.certPem),
);
```

### Integration with SROS2 (ADR-0092)

SPIRE issues 90-day DDS enclave certificates for the `portarium_bridge` enclave, replacing the manual `keystore-bootstrap.sh` CA step. The SPIRE SVID is written to the SROS2 keystore path via a sidecar CSR workflow (future work).

### Runtime requirements

```
SPIFFE_ENDPOINT_SOCKET=unix:///run/spire/sockets/agent.sock
```

The SPIRE Agent exposes the Workload API at this UDS path; it is mounted into each gateway pod via a `hostPath` volume.

### RBAC

SPIRE Server requires `get/list/watch` on `nodes` and `pods`, and `create` on `tokenreviews`. These are granted by `spire-server-role` ClusterRole. No other cluster-level permissions are needed.

---

## Alternatives Considered

### Vault PKI Secrets Engine only
Considered. Vault provides excellent certificate automation but requires an additional service and a Vault token exchange step. SPIFFE/SPIRE provides a more portable standard (SVIDs work with any SPIFFE-aware runtime). Both can be used together (SPIRE→Vault PKI upstream CA).

### cert-manager only
Rejected for runtime SVIDs. cert-manager issues certificates for Kubernetes Services (Ingress TLS), not for workload-to-workload mTLS inside the cluster. cert-manager can be used alongside SPIRE for ingress certificates.

### Long-lived static mTLS certificates
Rejected. Static certificates cannot be automatically rotated and are vulnerable to credential exfiltration.

---

## Consequences

**Positive**
- Zero-secret distribution: gateways receive SVIDs on-demand; no static credential files.
- Short-lived certificates limit blast radius of compromised keys.
- SPIFFE ID is verifiable by the remote end without consulting a registry.
- Standard: any SPIFFE-aware runtime (Envoy, gRPC, BoringSSL) can validate without Portarium-specific code.

**Negative / trade-offs**
- SPIRE adds two new workloads (Server StatefulSet + Agent DaemonSet) to the cluster.
- The SPIFFE Workload API package (`@spiffe/spiffe-workload-api`) must be added to `package.json` before production use.
- Robot-side gateways (outside k8s) require a SPIRE agent or equivalent (e.g. SPIRE on edge nodes, or OIDC token exchange).

---

## References

- SPIFFE specification — <https://spiffe.io/docs/latest/spiffe-about/spiffe-concepts/>
- SPIRE documentation — <https://spiffe.io/docs/latest/deploying/>
- Kubernetes PSAT attestor — <https://github.com/spiffe/spire/blob/main/doc/plugin_server_nodeattestor_k8s_psat.md>
