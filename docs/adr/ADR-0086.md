# ADR-0086: Progressive Delivery — Canary Strategy with SLO-Gated Promotion

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0394

## Context

Direct blue/green or rolling-update deployments mean that a defective release
reaches 100% of traffic before metrics are available to detect the problem.
For Portarium — where workflow correctness and evidence integrity have strict
SLOs — we need a deployment strategy that:

1. Limits blast radius to a small traffic fraction initially.
2. Automatically rolls back if SLO burn rates spike during the canary period.
3. Requires no manual intervention for the happy path.
4. Operates without downtime.

## Decision

Adopt **Argo Rollouts canary strategy** for both the control-plane HTTP service
and the execution-plane worker.

### Strategy per component

| Component | Traffic management | Progression |
|---|---|---|
| Control plane | NGINX ingress `canary-weight` annotation | 10% → 20% → 50% → 100% |
| Worker | Pod-count scaling (Temporal distributes naturally) | 33% → 67% → 100% |

### SLO-gated analysis

Argo Rollouts runs an `AnalysisTemplate` every 2 minutes during canary.
The analysis queries Prometheus for:

- API error rate: must be < 0.1%
- API p95 latency: must be < 500 ms
- Worker action failure rate: must be < 0.5%
- Evidence write failure rate: must be < 0.01%

Any single metric failure immediately aborts the rollout. Argo Rollouts
automatically scales the canary to 0 and promotes the stable revision —
zero-downtime rollback, no human action required.

### GitHub Actions orchestration (`cd-progressive.yml`)

The `cd-progressive.yml` workflow:
1. Verifies image provenance (re-uses `verify-provenance.yml` from ADR-0082).
2. Calls `kubectl argo rollouts set image` to trigger the rollout.
3. Polls rollout status and Prometheus SLO burn rates every 30 seconds.
4. If the max burn rate across all P0 SLOs exceeds 14× budget → calls
   `kubectl argo rollouts abort` (belt-and-suspenders on top of in-cluster
   AnalysisTemplate).
5. Updates GitHub Deployment status to `success` or `failure`.
6. Writes a summary table to the GitHub Actions step summary.

### Concurrency

The workflow uses `concurrency.group` scoped to `environment + component`
with `cancel-in-progress: false`. This prevents two simultaneous rollouts
to the same component/environment pair while still queueing new runs.

### Rollback path

| Trigger | Mechanism | Time to stable |
|---|---|---|
| Analysis metric failure | Argo Rollouts in-cluster abort | < 30 s |
| SLO burn-rate spike (external) | GitHub Actions abort + kubectl | < 60 s |
| Manual | `kubectl argo rollouts abort <name>` | < 30 s |
| Git revert + re-deploy | New rollout with previous image tag | < 5 min |

## Consequences

**Positive**
- Blast radius of defective releases limited to ≤ 10% of traffic at first exposure.
- SLO-gated analysis catches regressions before full promotion.
- Zero-downtime rollbacks built into Argo Rollouts.
- GitHub Deployment API provides audit trail of every progressive delivery.

**Negative / Trade-offs**
- Argo Rollouts controller must be installed and maintained separately from
  core Kubernetes.
- `AnalysisTemplate` Prometheus queries must be kept in sync with SLO recording
  rule names (coupling risk — mitigated by bead-0393 naming convention).
- Two separate services (stable + canary) per component adds resource overhead
  during rollout.
- Worker canary relies on Temporal's task-queue distribution being roughly
  uniform across pollers — this is generally true but not guaranteed under
  very low task rates.

## Alternatives Considered

- **Flagger (Flux GitOps)**: more GitOps-native but requires Flagger controller
  and Helm Operator; higher operational surface. Deferred.
- **Native Kubernetes RollingUpdate**: no traffic-weight control, no SLO
  analysis gate — rejected.
- **Blue/green full swap**: no partial exposure; cannot detect subtle regressions
  before full cutover — rejected.
- **Feature flags only**: application-level approach, orthogonal; can be
  combined with canary in future.

## Related

- ADR-0083: Environment model and artefact promotion pipeline
- ADR-0085: SLO definitions and alerting
- bead-0393: SLO recording rules (sloth-generated)
