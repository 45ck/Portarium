# ADR-0095 — Robot Mission Pre-emption and Stop-Path Latency Budgets

**Status:** Accepted
**Date:** 2026-02-22
**Bead:** bead-0529

---

## Context

Portarium dispatches robot missions through live gateways (ROS 2 action bridge,
OPC UA, MQTT). In safety-critical scenarios — e-stop, collision avoidance,
operator override — a cancel request must propagate to the physical robot within
a deterministic time bound.

Two latency paths require explicit budgets:

- **Pre-emption latency**: time from `cancelMission()` call to the gateway
  acknowledging the stop command (robot begins decelerating).
- **Stop-path latency**: end-to-end time from dispatch through cancel through
  confirmed terminal state (`Cancelled` or `Failed`).

Without documented budgets, gateway implementations may silently regress.

---

## Decision

### In-process (stub / unit test) budgets

These are verified by `preemption-stop-path-latency.test.ts`:

| Path                                          | Budget        |
| --------------------------------------------- | ------------- |
| Single cancel (no I/O)                        | ≤ 2 ms        |
| Full stop-path (dispatch → cancel → terminal) | ≤ 5 ms        |
| 20 concurrent cancels                         | ≤ 20 ms total |

### Live gateway budgets (per transport)

| Transport            | Pre-emption budget | Stop-path budget | Notes                        |
| -------------------- | ------------------ | ---------------- | ---------------------------- |
| ROS 2 (rosbridge)    | ≤ 100 ms           | ≤ 500 ms         | Goal message + cancel action |
| OPC UA (node-opcua)  | ≤ 200 ms           | ≤ 1 s            | Method call round-trip       |
| MQTT (topic publish) | ≤ 50 ms            | ≤ 300 ms         | QoS 1, retained e-stop topic |
| gRPC (bidirectional) | ≤ 50 ms            | ≤ 200 ms         | Streaming cancel             |

All live budgets assume LAN connectivity (< 5 ms RTT). WAN deployments require
explicit SLA negotiation.

### E-stop fast path

A hardware e-stop MUST NOT go through the Portarium control plane. The
`estop` ROS 2 topic (and physical safety relay) bypass software entirely.
The budgets above apply only to software-initiated cancel requests.

### Monotonicity invariant

Once a mission enters a terminal state (`Cancelled`, `Failed`, `Succeeded`),
its status MUST NOT regress. Concurrent or duplicate cancels on a terminal
mission are idempotent — they return their result without changing state.

### Idempotency invariant

A dispatch with a previously-seen `planEffectIdempotencyKey` returns the
original `gatewayRequestId` without re-executing. This prevents double-dispatch
during retry storms.

---

## Consequences

- `preemption-stop-path-latency.test.ts` is added to CI and fails the build
  if in-process budgets are violated.
- Live gateway integration tests (bead-0519) will benchmark against the
  per-transport live budgets in a Gazebo/Webots simulation environment.
- Any gateway implementation that introduces a code path slower than the
  in-process budget must add a comment explaining the deliberate tradeoff.
- The `LatencyTestMissionPort` stub introduced in this bead is the reference
  implementation for future gateway latency tests.

---

## Alternatives Considered

**Dedicated benchmark framework (tinybench / vitest bench)**
vitest's `bench()` API measures throughput, not latency budget compliance.
Using `performance.now()` inside `it()` blocks gives clearer pass/fail
semantics and integrates with CI without a separate benchmark runner.

**Skipping in-process benchmarks, testing only live gateways**
Live gateway tests are slower, require simulation infrastructure, and are
flaky under load. In-process tests catch regressions in the code path
cheaply and run on every PR.
