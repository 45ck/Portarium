# ADR-0089: FinOps Tagging and Cost Governance

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0398

## Context

Portarium runs across three environments (dev, staging, prod) and will
eventually host hundreds of tenants on isolated storage. Without structured
cost attribution, it is impossible to:

- Allocate cloud spend to environments or tenants for chargeback/showback.
- Detect cost anomalies before they exceed budget.
- Enforce hygiene (untagged resources cannot be attributed).
- Model the unit economics of per-tenant compute and storage.

## Decision

### Mandatory resource tags

All Portarium-managed resources must carry the following tags:

| Tag key | Example value | Used for |
|---|---|---|
| `Project` | `portarium` | Top-level cost filter |
| `Environment` | `prod` | Per-environment budget |
| `ManagedBy` | `Terraform` | Drift detection |
| `TenantId` | `acme-corp` | Per-tenant cost breakdown (dedicated tier only) |
| `StorageTier` | `dedicated` | Storage-tier analysis |

Tags `Project`, `Environment`, and `ManagedBy` are mandatory on all resource
types. Compliance is enforced via AWS Config rule `required-tags`
(provisioned by the `finops` Terraform module).

### Environment budgets

Monthly cost budgets are defined per environment:

| Environment | Budget (USD/month) | Warning threshold |
|---|---|---|
| dev | $500 | 80% forecasted |
| staging | $1 500 | 80% forecasted |
| prod | $10 000 | 80% forecasted + 100% actual |

Alerts are sent to `ops@portarium.io` and `finance@portarium.io`.

### Cost anomaly detection

AWS Cost Anomaly Monitor detects spend spikes > 20% above the trailing
7-day average AND > $50 absolute impact. Alerts fire daily and are sent
to the same distribution list as budget alerts.

### Cost allocation tags

`Project`, `Environment`, `ManagedBy`, and `TenantId` are activated in
AWS Cost Explorer via `aws_ce_cost_allocation_tag` resources. This enables
filtering and grouping by these dimensions in Cost Explorer, Budgets, and
the weekly cost report.

### Weekly cost report

`finops-cost-report.yml` runs every Monday at 08:00 UTC:
1. Queries Cost Explorer for 7-day spend by environment (tag group).
2. Queries spend by AWS service (top 15 by cost).
3. Checks AWS Config for non-compliant (untagged) resources.
4. Posts summary to GitHub Actions Step Summary.
5. Uploads raw JSON cost reports as artefacts (90-day retention).

### Right-sizing and autoscaling strategy

Right-sizing is addressed at the infrastructure layer, not by this bead,
but the tagging strategy enables it:

- EKS node groups use `ON_DEMAND` capacity with Karpenter (future bead)
  for bin-packing and automatic instance-type selection.
- RDS instances use `db.t4g.medium` (graviton, cost-optimised) in staging,
  `db.r7g.*` in prod (memory-optimised for PostgreSQL).
- S3 Intelligent-Tiering is applied to evidence buckets after 90 days.

## Consequences

**Positive**
- Tag compliance rule catches untagged resources created outside Terraform.
- Per-environment budgets provide early warning before overspend.
- Weekly cost report gives engineering and finance a shared view of spend.
- TenantId tag enables future chargeback to enterprise customers.

**Negative / Trade-offs**
- AWS Config recorder incurs additional cost (~$0.003/resource recorded/month).
  For accounts with < 500 resources this is < $15/month.
- Cost Explorer data has a 24h lag; anomaly alerts are not real-time.
- `aws_ce_cost_allocation_tag` resources require the tag to already exist on
  at least one resource before Cost Explorer accepts them â€” bootstrap order
  matters.

## Related

- ADR-0083: Environment model
- ADR-0084: Multi-tenant storage tiers (TenantId tag)
- bead-0395: CI OIDC (cost-report workflow uses OIDC role)
