# ADR-0087: CI OIDC Federation for Cloud Access (No Long-Lived Credentials)

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0395

## Context

Portarium's CI/CD pipelines (GitHub Actions) push images to container
registries, deploy to EKS, and invoke cloud APIs. Previously this required
long-lived service-account keys or access keys stored in GitHub Secrets.
Long-lived credentials are:

- A persistent compromise vector (key leaks in logs, confused-deputy attacks).
- Subject to manual rotation and revocation overhead.
- Ineligible for SLSA Level 3 provenance, which requires ephemeral credentials
  tied to a specific workflow run.

## Decision

Replace all long-lived cloud credentials in GitHub Actions with **OIDC
federated identity**, using the cloud-provider-native token exchange:

| Cloud | Mechanism | Terraform resource |
|---|---|---|
| AWS | `aws-actions/configure-aws-credentials@v4` → `AssumeRoleWithWebIdentity` | `aws_iam_openid_connect_provider` + `aws_iam_role` |
| GCP | `google-github-actions/auth@v2` → Workload Identity Federation | `google_iam_workload_identity_pool_provider` + `google_service_account` |
| Azure | `azure/login@v2` with federated credential | `azuread_application_federated_identity_credential` |

All three are provisioned by the reusable Terraform module
`infra/terraform/modules/github-oidc`.

### Subject claim scoping

OIDC tokens are scoped to minimise blast radius:

- Main-branch deploys: `repo:<org>/<repo>:ref:refs/heads/main`
- Environment deploys: `repo:<org>/<repo>:environment:<env>` (staging, prod)
- Additional subjects can be added via `extra_subjects` for preview environments.

The AWS IAM role's trust policy uses `StringLike` (not `StringEquals`) for the
`sub` condition to support both patterns with one role. The role has
`max_session_duration = 3600` seconds — no CI job should run longer.

### Principle of least privilege

The baseline IAM policy (inline `github-ci-baseline`) grants:
- `eks:DescribeCluster` + `eks:AccessKubernetesApi` — scoped to clusters
  matching the namespace/environment prefix.
- `ecr:GetAuthorizationToken` — account-wide (required by the ECR API).
- ECR push actions — scoped to `ecr:repository/<namespace>/*`.

Additional permissions are attached via `aws_deploy_policy_arns` (passed in by
the root module) — this prevents the module from granting overly broad
permissions by default.

### Existing workflow migration

Workflows that previously used `AWS_ACCESS_KEY_ID` / `AWS_SECRET_ACCESS_KEY`
secrets are updated to:

```yaml
- name: Configure AWS credentials (OIDC)
  uses: aws-actions/configure-aws-credentials@v4
  with:
    role-to-assume: ${{ vars.AWS_DEPLOY_ROLE_ARN }}
    aws-region: ${{ vars.AWS_REGION }}
```

`AWS_DEPLOY_ROLE_ARN` is a repository/environment variable (not a secret) —
it is not sensitive and can be inspected in the Actions UI.

### One provider per account

`aws_create_oidc_provider = false` must be set in child modules when the
GitHub OIDC provider already exists in the account (only one per account is
allowed). The module handles this via the `aws_create_oidc_provider` variable.

## Consequences

**Positive**
- No long-lived credentials at rest — eliminates the most common CI/CD
  credential leak vector.
- Token lifetime ≤ 1 hour, scoped to a single workflow run.
- SLSA Level 3 compatible: provenance can assert the OIDC identity used.
- Easier auditing: CloudTrail / GCP Audit Logs show the GitHub subject claim.

**Negative / Trade-offs**
- Terraform must be applied before any workflow can authenticate.
- Adding a new environment requires updating both the Terraform `allowed_environments`
  list and re-running `terraform apply`.
- GCP Workload Identity Federation has a ~5-minute eventual-consistency delay
  after the provider is created before tokens are accepted.
- Azure requires `AZURE_TENANT_ID` and `AZURE_SUBSCRIPTION_ID` in workflow
  vars (not secrets, but must be set).

## Related

- ADR-0083: Environment model
- ADR-0086: Progressive delivery
- bead-0329: CI/CD provenance and image signing (uses OIDC identity for Sigstore)
