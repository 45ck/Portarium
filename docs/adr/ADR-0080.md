# ADR-0080: Execution-Plane Egress Allowlist Strategy — NetworkPolicy vs FQDN Filtering

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0327

## Context

Execution-plane workers execute adapter calls to external Systems of Record (SoR).
`MachineExecutionPolicy.egressAllowlist` defines which hostnames/CIDR ranges a
workflow is permitted to contact. We need to enforce this at the infrastructure
level — not just the application layer — to provide defence-in-depth.

Kubernetes `NetworkPolicy` operates at the IP/port layer and cannot filter by
hostname (FQDN). We considered three options:

| Option | Mechanism | Pros | Cons |
|---|---|---|---|
| 1. Kubernetes NetworkPolicy (port only) | Standard k8s API | No CNI dependency; universally supported | Cannot filter by FQDN; permits any IP on :443 |
| 2. Cilium `CiliumNetworkPolicy` with `toFQDNs` | Cilium CNI required | FQDN-level enforcement; DNS-aware | Requires Cilium as CNI; adds operational complexity |
| 3. Istio `ServiceEntry` + `AuthorizationPolicy` | Istio service mesh | FQDN + mTLS + JWT; rich policy language | Full mesh required; sidecars in every pod |

## Decision

**Short-term (current bead)**: Apply standard `NetworkPolicy` allowing egress on
TCP/443 and TCP/80. Application-layer enforcement of `egressAllowlist` is
mandatory and provides the primary control. The `portarium-execution` namespace
`PodSecurity=restricted` label prevents privilege escalation that could bypass
network controls.

**Medium-term path**: When the cluster CNI is Cilium, replace (or augment) the
standard `NetworkPolicy` with `CiliumNetworkPolicy` using `toFQDNs` selectors
generated from `MachineExecutionPolicy.egressAllowlist` at deploy time. This
closes the IP-layer gap without requiring a full service mesh.

**Out of scope for this ADR**: Istio adoption. That is a separate architectural
decision tracked in the service-mesh backlog.

## Consequences

- Workers may open TCP/443 connections to any external IP; the application layer
  (`MachineExecutionPolicy` evaluation before `AdapterCallRequested`) is the
  authoritative enforcement point.
- A future Cilium migration will add FQDN-level enforcement without breaking
  existing standard `NetworkPolicy` objects (Cilium supports both).
- The `portarium-execution` namespace isolation and `PodSecurity=restricted`
  reduce the blast radius if a worker pod is compromised.
