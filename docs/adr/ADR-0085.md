# ADR-0085: SLO Definitions, Dashboards, and Alerting Strategy

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0393

## Context

Portarium has Prometheus metrics and an OTel Collector pipeline (ADR-0073) but
no formal SLO budget model. Operators cannot distinguish normal fluctuation
from budget-threatening trends, and alert fatigue from threshold-based rules
causes notification blindness.

## Decision

Adopt **Google SRE Workbook Chapter 5** multi-window, multi-burn-rate (MWMBR)
alerting, with SLO definitions maintained as **OpenSLO v1** YAML
(`infra/otel/slos/portarium-slos.yaml`) and rendered to Prometheus recording
rules by `sloth`.

### Defined SLOs

| SLO                                    | Target | Window      | Tier |
| -------------------------------------- | ------ | ----------- | ---- |
| API Availability                       | 99.9%  | 30d rolling | P0   |
| API Latency p95 ≤ 500ms                | 95%    | 30d rolling | P0   |
| Workflow Completion Rate               | 99%    | 30d rolling | P0   |
| Workflow Latency p90 ≤ 60s (automated) | 90%    | 30d rolling | P1   |
| Worker Action Success Rate             | 99.5%  | 30d rolling | P0   |
| Evidence Integrity Write Success       | 99.99% | 30d rolling | P0   |

### Alert levels

Two alert levels per SLO, avoiding both alert storms and missed incidents:

| Level      | Burn multiple | Windows checked | Routing                          |
| ---------- | ------------- | --------------- | -------------------------------- |
| **page**   | > 14× budget  | 1h AND 5m       | PagerDuty P1 — on-call engineer  |
| **ticket** | > 6× budget   | 6h AND 30m      | PagerDuty P2 — next business day |

Exception: Evidence Integrity uses **page** for both fast and slow burn,
because even a sustained slow-burn risks audit trail gaps unacceptable for
compliance.

### Error budget policy

- Error budget is tracked per 30-day rolling window.
- When remaining budget falls below **25%**: risky deployments require
  additional reviewer approval.
- When remaining budget falls below **10%**: deployment freeze on affected
  service; only bugfix PRs permitted.
- Budget exhaustion event triggers a post-mortem within 5 business days.

### Toolchain

| Component       | Tool                                                   |
| --------------- | ------------------------------------------------------ |
| SLO definition  | OpenSLO v1 YAML                                        |
| Recording rules | `sloth generate` (CI step, not yet wired)              |
| Alerting rules  | Prometheus Alertmanager (YAML in `infra/otel/alerts/`) |
| Dashboards      | Grafana 10 (JSON in `infra/otel/dashboards/`)          |
| Provisioning    | Grafana sidecar (`grafana/sidecar`) via ConfigMap      |

### Dashboard

`slo-overview.dashboard.json` provides:

- Budget gauge per SLO (red < 10%, yellow < 25%, green ≥ 25%)
- Burn rate timeseries with page and ticket threshold overlays
- Horizontal bar-gauge comparing remaining budget across all SLOs

### Metric instrumentation requirements

Services must emit the following counters (see also OTel semantic conventions):

| Counter                                        | Labels              |
| ---------------------------------------------- | ------------------- |
| `http_requests_total`                          | `service`, `code`   |
| `http_request_duration_ms_{bucket,count,sum}`  | `service`, `le`     |
| `portarium_run_started_total`                  | —                   |
| `portarium_run_completed_total`                | —                   |
| `portarium_run_duration_ms_{bucket,count,sum}` | `requires_approval` |
| `portarium_worker_action_started_total`        | —                   |
| `portarium_worker_action_succeeded_total`      | —                   |
| `portarium_evidence_write_attempted_total`     | —                   |
| `portarium_evidence_write_succeeded_total`     | —                   |

## Consequences

**Positive**

- Two-alert-level MWMBR model reduces both alert fatigue and detection latency.
- OpenSLO YAML is human-readable and diff-friendly; rendering is automated.
- Budget policy creates a clear, shared language between engineering and product.

**Negative / Trade-offs**

- `sloth` rendering step must be added to CI (currently manual).
- Recording rule names must be consistent across alert rules and dashboards
  (fragile until sloth generates them automatically).
- 99.99% Evidence Integrity SLO leaves only ~4 minutes of error budget per
  month — any write failure triggers an alert. Requires robust retry logic
  in the evidence store adapter.

## Related

- ADR-0073: OTel Collector configuration
- ADR-0083: Environment model and artefact promotion pipeline
- bead-0428: OTel Collector production pipeline (OTLP backend)
