# ADR-0082: CloudEvents Type Versioning Governance and Schema Registry Pattern

**Status**: Accepted
**Date**: 2026-02-22
**Bead**: bead-0383

## Context

Portarium uses CloudEvents as the external choreography envelope for
domain events (ADR-0070). As the system evolves, event schemas will change.
Without governance rules, schema drift causes silent consumer failures,
breaking integrations and audit trails.

We need:
1. A **versioning convention** embedded in the CloudEvents `type` attribute.
2. An **in-process schema registry** for routing versioned events to handlers.
3. **Consumer resilience** rules so that consumers tolerate additive changes
   and new event versions without crashing.

## Decisions

### 1. Event type versioning convention

**Format**: `com.portarium.<aggregate-lowercase>.<EventName>.v<N>`

| Example | Meaning |
|---|---|
| `com.portarium.run.RunStarted.v1` | First schema version |
| `com.portarium.approval.ApprovalGranted.v2` | Breaking change: v2 |

Rules:
- All **new** event types MUST include a `.v<N>` suffix (N ≥ 1).
- Legacy types without a version suffix are `UnversionedType` and MUST be
  migrated before their handlers are removed.
- **Additive changes** (new optional fields, no removed fields, no type
  changes) do NOT require a version bump — consumers forward-compatibly ignore
  unknown fields.
- **Breaking changes** (removed required fields, changed field types, renamed
  fields) MUST increment N.
- The `dataschema` attribute SHOULD be set to a canonical schema URL when a
  JSON Schema is maintained for the event data payload.

### 2. Schema registry

`CloudEventSchemaRegistry` (`src/application/events/event-schema-registry-v1.ts`):
- Handlers are registered per `(aggregate, eventName, version)`.
- `dispatch(event)` routes to the exact handler, or falls back gracefully.
- Returns a typed `DispatchResult` — never throws on unknown event types.
- Emits structured `RegistryWarning` notifications (via `onWarning` callback)
  for observability when version fallback occurs.

### 3. Consumer resilience rules

| Scenario | Behaviour |
|---|---|
| Exact version match | Dispatch to registered handler, no warning |
| Received version higher than any registered | Fall back to highest registered version ≤ received; emit `UnknownFutureVersion` warning |
| Received version lower than all registered | Fall back to lowest registered version; emit `FallbackToLowerVersion` warning |
| Completely unknown type | Return `{ handled: false, reason: 'UnknownType' }` — do NOT crash |
| Unversioned legacy type | Return `{ handled: false, reason: 'UnversionedType' }` |
| No handler registered for known aggregate | Return `{ handled: false, reason: 'NoHandlerRegistered' }` |

Consumers MUST log `RegistryWarning` events and MUST NOT treat `handled: false`
as an error — unknown events are a normal part of forward compatibility.

### 4. Schema registry deployment model

The schema registry is **in-process** (not an external service). Each
application instance registers its known handlers at startup. There is no
centralised schema registry service in this architecture. The `listRegistrations()`
method enables runtime introspection for health checks and compatibility matrices.

A future evolution may integrate with a schema registry service (e.g. Confluent
Schema Registry, AWS Glue) by extending the `dataschema` URL convention; this
ADR does not preclude that.

## Consequences

- All new event types require a `.v<N>` suffix — linting/CI should enforce this.
- Producers MUST set `dataschema` when a canonical JSON Schema exists.
- Consumers implementing `CloudEventSchemaRegistry` are resilient to new event
  versions deployed ahead of consumer upgrades (tolerates the common canary
  deployment pattern).
- The `onWarning` callback enables integration with OTel metrics for alerting
  on persistent version mismatches.
