version: '3.9'

# ---------------------------------------------------------------------------
# Local override â€” builds API and worker from source (cockpit profile).
#
# Combine with the base compose file profiles to bring up the full stack:
#
#   COMPOSE_PROFILES=baseline,runtime,auth,cockpit \
#     docker compose -f docker-compose.yml -f docker-compose.local.yml up -d
# ---------------------------------------------------------------------------

services:
  api:
    profiles: [cockpit]
    build:
      context: .
      dockerfile: infra/docker/control-plane.Dockerfile
    container_name: portarium-api
    environment:
      PORTARIUM_ENVIRONMENT: local
      PORTARIUM_RUNTIME_PROFILE: local-sandbox
    depends_on:
      temporal:
        condition: service_started
      evidence-db:
        condition: service_healthy
      evidence-store:
        condition: service_healthy
      vault:
        condition: service_started
      otel-collector:
        condition: service_started
    ports:
      - '8080:8080'
    networks:
      - portarium-control

  worker:
    profiles: [cockpit]
    build:
      context: .
      dockerfile: infra/docker/worker.Dockerfile
    container_name: portarium-worker
    environment:
      PORTARIUM_ENVIRONMENT: local
      PORTARIUM_RUNTIME_PROFILE: local-sandbox
    depends_on:
      temporal:
        condition: service_started
      vault:
        condition: service_started
      evidence-db:
        condition: service_healthy
      otel-collector:
        condition: service_started
    ports:
      - '8081:8081'
    networks:
      - portarium-control
