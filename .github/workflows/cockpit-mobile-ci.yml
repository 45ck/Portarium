name: Cockpit Mobile CI

# Builds and validates Portarium Cockpit iOS/Android native wrappers.
# Runs on PRs that touch the cockpit app or native configuration.
#
# Bead: bead-0723

on:
  pull_request:
    paths:
      - 'apps/cockpit/**'
      - '.github/workflows/cockpit-mobile-ci.yml'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build (ios | android | both)'
        required: false
        default: 'both'

concurrency:
  group: cockpit-mobile-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '24'

# ── Jobs ──────────────────────────────────────────────────────────────────────

jobs:
  # ── Web build (prerequisite for native sync) ────────────────────────────────
  web-build:
    name: Web build (dist/)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build cockpit SPA
        run: npm run -w apps/cockpit build
        env:
          VITE_VAPID_PUBLIC_KEY: ${{ secrets.VITE_VAPID_PUBLIC_KEY || 'test-placeholder' }}

      - name: Upload dist artifact
        uses: actions/upload-artifact@v4
        with:
          name: cockpit-dist
          path: apps/cockpit/dist/
          retention-days: 1

  # ── iOS build ───────────────────────────────────────────────────────────────
  ios-build:
    name: iOS build (Xcode)
    runs-on: macos-14
    timeout-minutes: 45
    needs: web-build
    if: |
      github.event_name == 'workflow_dispatch' && inputs.platform != 'android'
      || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: cockpit-dist
          path: apps/cockpit/dist/

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli@latest

      - name: Capacitor sync (ios)
        run: npx cap sync ios
        working-directory: apps/cockpit

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app

      - name: iOS smoke build (simulator)
        run: |
          xcodebuild \
            -workspace ios/App/App.xcworkspace \
            -scheme App \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=17.5' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            build
        working-directory: apps/cockpit

      - name: Upload iOS build log
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ios-build-log
          path: /tmp/xcodebuild-*.log

  # ── Android build ───────────────────────────────────────────────────────────
  android-build:
    name: Android build (Gradle)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: web-build
    if: |
      github.event_name == 'workflow_dispatch' && inputs.platform != 'ios'
      || github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install deps
        run: npm ci

      - name: Download dist artifact
        uses: actions/download-artifact@v4
        with:
          name: cockpit-dist
          path: apps/cockpit/dist/

      - name: Install Capacitor CLI
        run: npm install -g @capacitor/cli@latest

      - name: Capacitor sync (android)
        run: npx cap sync android
        working-directory: apps/cockpit

      - name: Android smoke build (debug APK)
        run: ./gradlew assembleDebug --no-daemon
        working-directory: apps/cockpit/android

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: cockpit-debug-apk
          path: apps/cockpit/android/app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7

  # ── Smoke test: native capability contract ──────────────────────────────────
  smoke-tests:
    name: Native capability smoke tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: web-build

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Run mobile smoke tests
        run: npm run test -- --run src/infrastructure/adapters/mobile-smoke.test.ts src/infrastructure/adapters/push-notification-registration.test.ts src/infrastructure/adapters/oidc-pkce-auth.test.ts

  # ── Summary gate ────────────────────────────────────────────────────────────
  mobile-ci-ok:
    name: Mobile CI gate
    runs-on: ubuntu-latest
    needs: [web-build, smoke-tests]
    if: always()

    steps:
      - name: Check required jobs
        run: |
          if [[ "${{ needs.web-build.result }}" != "success" ]]; then
            echo "web-build failed"; exit 1
          fi
          if [[ "${{ needs.smoke-tests.result }}" != "success" ]]; then
            echo "smoke-tests failed"; exit 1
          fi
          echo "All required mobile CI jobs passed"
