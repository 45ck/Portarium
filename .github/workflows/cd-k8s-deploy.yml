name: CD (Platform Deploy)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        default: dev
        options:
          - dev
          - staging
          - prod
      image_tag:
        description: 'Container image tag to apply (defaults to latest)'
        required: false
        default: ''
      apply:
        description: 'Apply manifests directly to the selected cluster'
        required: true
        default: 'false'
        type: boolean

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Dry-run schema migrations (expand phase)
        run: npm run migrate:deploy

      - name: Resolve overlay and image tag
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            echo "overlay=infra/kubernetes/overlays/dev" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event.inputs.environment }}" = "staging" ]; then
            echo "overlay=infra/kubernetes/overlays/staging" >> "$GITHUB_OUTPUT"
          else
            echo "overlay=infra/kubernetes/overlays/prod" >> "$GITHUB_OUTPUT"
          fi

          if [ -n "${{ github.event.inputs.image_tag }}" ]; then
            echo "image_tag=${{ github.event.inputs.image_tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "image_tag=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Build manifest
        id: manifest
        shell: bash
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -w /workspace \
            k8s.gcr.io/kustomize/kustomize:v5.4.2 \
            build "${{ steps.resolve.outputs.overlay }}" > /tmp/manifest.yaml

          if [ "${{ steps.resolve.outputs.image_tag }}" != "latest" ]; then
            sed -i \
              -e "s#ghcr.io/your-org/portarium-control-plane:latest#ghcr.io/your-org/portarium-control-plane:${{ steps.resolve.outputs.image_tag }}#g" \
              -e "s#ghcr.io/your-org/portarium-worker:latest#ghcr.io/your-org/portarium-worker:${{ steps.resolve.outputs.image_tag }}#g" \
              /tmp/manifest.yaml
          fi

      - name: Validate manifest
        run: |
          if [ ! -s /tmp/manifest.yaml ]; then
            echo "Manifest generation failed."
            exit 1
          fi
          kubectl apply --dry-run=client -f /tmp/manifest.yaml

      - name: Deploy control and execution planes
        if: github.event.inputs.apply == 'true'
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}
        run: |
          if [ -z "$KUBECONFIG_B64" ]; then
            echo "KUBECONFIG_B64 secret is required when apply=true."
            exit 1
          fi

          echo "$KUBECONFIG_B64" | base64 -d > /tmp/kubeconfig
          export KUBECONFIG=/tmp/kubeconfig
          kubectl apply -f /tmp/manifest.yaml
          kubectl rollout status deployment/portarium-control-plane -n portarium --timeout=120s
          kubectl rollout status deployment/portarium-execution-plane -n portarium --timeout=120s
