name: CD (Promote Artefact)

# Promotes a built image SHA to a Kustomize overlay and commits the pinned tag.
# This is the first half of the GitOps deploy loop; the second half is
# cd-k8s-deploy.yml which applies the updated overlay to the cluster.
#
# Dev:      auto-triggered after CI (Container Images) succeeds on main.
# Staging:  manual workflow_dispatch, requires 1 GitHub environment reviewer.
# Prod:     manual workflow_dispatch, requires 2 GitHub environment reviewers.

on:
  # Auto-promote to dev after every successful image build on main.
  workflow_run:
    workflows: ['CI (Container Images)']
    types: [completed]
    branches: [main]

  # Manual promotion to staging or prod.
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment to promote to'
        required: true
        type: choice
        options:
          - staging
          - prod
      image_sha:
        description: 'Git SHA of the image to promote (leave blank to use latest on main)'
        required: false
        default: ''

permissions:
  contents: write
  id-token: write

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # resolve-artefact
  # Determines the image SHA and target environment for this promotion.
  # ─────────────────────────────────────────────────────────────────────────────
  resolve-artefact:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    outputs:
      image_sha: ${{ steps.resolve.outputs.image_sha }}
      target_environment: ${{ steps.resolve.outputs.target_environment }}

    steps:
      - name: Resolve image SHA and target environment
        id: resolve
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            # Auto-promotion: use the SHA from the triggering CI run.
            echo "image_sha=${{ github.event.workflow_run.head_sha }}" >> "$GITHUB_OUTPUT"
            echo "target_environment=dev" >> "$GITHUB_OUTPUT"
          else
            # Manual promotion: use provided SHA or fall back to current HEAD.
            SHA="${{ github.event.inputs.image_sha }}"
            if [ -z "$SHA" ]; then
              SHA="${{ github.sha }}"
            fi
            echo "image_sha=${SHA}" >> "$GITHUB_OUTPUT"
            echo "target_environment=${{ github.event.inputs.target_environment }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Log promotion intent
        run: |
          echo "Promoting SHA=${{ steps.resolve.outputs.image_sha }} → ${{ steps.resolve.outputs.target_environment }}"

  # ─────────────────────────────────────────────────────────────────────────────
  # pin-artefact
  # Updates the target overlay's kustomization.yaml with the resolved SHA and
  # commits the change to main. GitHub environment protection rules enforce the
  # approval gate for staging and prod before this job runs.
  # ─────────────────────────────────────────────────────────────────────────────
  pin-artefact:
    needs: resolve-artefact
    runs-on: ubuntu-latest
    # Referencing the GitHub environment triggers the environment protection rules
    # (required reviewers, deployment branch restrictions) configured in GitHub
    # repository settings for staging and prod.
    environment: ${{ needs.resolve-artefact.outputs.target_environment }}

    env:
      IMAGE_SHA: ${{ needs.resolve-artefact.outputs.image_sha }}
      TARGET_ENV: ${{ needs.resolve-artefact.outputs.target_environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Use the default GITHUB_TOKEN — it is configured to push to main if
          # the "Allow GitHub Actions to create and approve pull requests" setting
          # is enabled and the branch protection bypass list includes the Actions app.
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Kustomize
        run: |
          KUSTOMIZE_VERSION="v5.4.2"
          curl -sLO "https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2F${KUSTOMIZE_VERSION}/kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          tar xzf "kustomize_${KUSTOMIZE_VERSION}_linux_amd64.tar.gz"
          sudo mv kustomize /usr/local/bin/
          kustomize version

      - name: Pin image SHA in overlay
        run: |
          OVERLAY="infra/kubernetes/overlays/${TARGET_ENV}"

          # kustomize edit set image updates the newTag for matching image names
          # in-place in kustomization.yaml.
          cd "${OVERLAY}"
          kustomize edit set image \
            "ghcr.io/your-org/portarium-control-plane:${IMAGE_SHA}"
          kustomize edit set image \
            "ghcr.io/your-org/portarium-worker:${IMAGE_SHA}"
          cd "$GITHUB_WORKSPACE"

          echo "Updated ${OVERLAY}/kustomization.yaml:"
          cat "${OVERLAY}/kustomization.yaml"

      - name: Commit and push overlay update
        run: |
          git config user.name "portarium-bot[bot]"
          git config user.email "portarium-bot[bot]@users.noreply.github.com"

          git add "infra/kubernetes/overlays/${TARGET_ENV}/kustomization.yaml"

          if git diff --cached --quiet; then
            echo "Overlay already pinned to SHA ${IMAGE_SHA} — no commit needed."
            exit 0
          fi

          SHORT_SHA="${IMAGE_SHA:0:12}"
          git commit -m "chore(promote): pin ${TARGET_ENV} to ${SHORT_SHA}"
          git push origin main

      - name: Promotion summary
        run: |
          echo ""
          echo "──────────────────────────────────────────────────"
          echo "  Artefact promoted to ${TARGET_ENV}"
          echo "  SHA: ${IMAGE_SHA}"
          echo ""
          echo "  Next step: apply to cluster via cd-k8s-deploy.yml"
          echo "  workflow_dispatch with environment=${TARGET_ENV}"
          echo "  and image_tag=${IMAGE_SHA}"
          echo "──────────────────────────────────────────────────"
