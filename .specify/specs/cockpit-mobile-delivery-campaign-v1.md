# Spec: Cockpit Mobile Delivery Campaign — PWA-First + Capacitor iOS/Android (v1)

**Bead:** bead-0714 (campaign parent)
**ADR:** [ADR-0094](../../docs/adr/ADR-0094.md)
**Child beads:** bead-0719 (PWA), bead-0720 (Capacitor), bead-0721 (OIDC auth), bead-0722 (push), bead-0723 (release hardening)

## Context

Portarium Cockpit is a React/Vite SPA. Field operators increasingly use mobile devices (iOS/Android) on-site.
The mobile delivery campaign delivers an installable, offline-capable, notification-aware Cockpit on all platforms.

## Requirements

### Track A — PWA

1. Cockpit must be installable via "Add to Home Screen" on iOS and Android.
2. A service worker (generated by `vite-plugin-pwa` / Workbox) must precache `index.html` and critical JS/CSS bundles.
3. Navigation routes must be cached network-first with a 3-second fallback to stale cache.
4. `apps/cockpit/public/site.webmanifest` must include `screenshots[]` and `shortcuts[]`.
5. PWA Lighthouse score ≥ 90 in `ci:nightly`.

### Track B — Capacitor native wrapper

6. `apps/cockpit/capacitor.config.ts` must define `appId`, `appName`, `webDir: "dist"`, and iOS/Android OIDC deep-link scheme.
7. `src/lib/native-bridge.ts` must provide the primary gateway to Capacitor plugin APIs; no **static** `@capacitor/*` imports are permitted in `apps/cockpit/src/` outside of `native-bridge.ts` (dynamic `await import()` calls for optional native plugins are allowed).
8. `native-bridge.ts` must expose: `isNative()`, `isInstalledPwa()`, `secureGet/Set/Remove()`, `onDeepLink()`, `openInAppBrowser()`, `hapticTap()`, `writeToClipboard()`, `share()`, `setStatusBarStyle()`, `getAppInfo()`.
9. All native-bridge functions must fall back gracefully to Web API equivalents (or no-ops) when running in a browser.

### Auth (OIDC PKCE mobile)

10. OIDC PKCE flow must use `@capacitor/browser` (in-app browser) on native and standard `window.location` redirect on web.
11. Tokens must be stored in `@capacitor/preferences` (Keychain/Keystore) on native and `sessionStorage` on web.

### Push notifications

12. Web push must use the Push API + VAPID keys.
13. Native push must use `@capacitor/push-notifications` (APNs on iOS, FCM on Android).
14. The backend must expose a device-token registration endpoint triggered by `MissionFailed` and approval-pending CloudEvents.

## Test coverage required

- `native-bridge.test.ts`: ≥ 12 unit tests covering all exported functions, runtime detection, web fallbacks, and secure-storage paths.
- `mobile-shell.test.tsx`: route-render smoke tests for the mobile shell.
- `pwa-manifest.test.ts`: manifest structural validity assertions.
- `supply-chain-guardrails.test.ts`: if any `@capacitor/*` packages are added, they must use the official `@capacitor/` namespace (MIT-licensed).

## Review signal

Campaign reviewed against ADR-0094. All five child beads (bead-0719, bead-0720, bead-0721, bead-0722, bead-0723) closed and merged to main.

## Docs

- ADR-0094 documents the two-track PWA + Capacitor architecture, implementation order, and alternatives considered.
- `apps/cockpit/capacitor.config.ts` and `src/lib/native-bridge.ts` serve as the canonical reference implementation.

## Acceptance

- All child beads (bead-0719 through bead-0723) are closed.
- `npm run ci:pr` passes, including native-bridge and mobile-shell tests.
- `apps/cockpit/capacitor.config.ts` is present and valid.
- `src/lib/native-bridge.ts` exports all required functions.
- No **static** `@capacitor/*` imports outside `native-bridge.ts` in `apps/cockpit/src/`.
