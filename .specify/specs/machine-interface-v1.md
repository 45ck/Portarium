# Machine Interface v1

## Purpose

Machines are autonomous artifact producers (content machines, poster machines, reporter machines) registered through
`machineRegistrations` on an `AdapterRegistrationV1`.

The control plane invokes them over a network interface and persists resulting artifacts as evidence
inputs for runs, approvals, and evidence entries.

## Invocation contract

- All machine calls are HTTPS requests to the registered `endpointUrl`.
- Each machine MUST support:
  - `POST /v1/invoke` with a JSON body (`MachineInvokeRequestV1`)
  - `GET /v1/invoke/{invocationId}/status` for terminal state checks
- Requests SHOULD carry an idempotency key.
- Responses SHOULD complete with a machine-side status object and artifact references; long-running work MAY be executed async.

## `MachineInvokeRequestV1` (recommended shape)

- `schemaVersion`: `1`
- `invocationId`: idempotent opaque ID generated by caller
- `machineId`: registered `MachineId`
- `workspaceId`: caller workspace
- `planId?`: optional `PlanId`
- `runId?`: optional `RunId`
- `action`: human-readable action name
- `input`: opaque JSON payload for model/skill-specific input
- `callbackUrl?`: optional callback URL for async completion events

## Response shape

- `schemaVersion`: `1`
- `invocationId`: mirrors request
- `status`: `accepted | running | completed | failed`
- `artifactUris?`: array of artifact URIs produced by the machine
- `error?`: machine-defined error details

## Transport and security

- Transport MUST be TLS 1.2+ with certificate validation.
- Authorization SHOULD use one of:
  - mTLS with certificate pinning
  - short-lived bearer token
  - dedicated signed service token
- Calls must be bounded by tenant, action, and budget timeout limits.
- Control-plane side SHOULD retry only safe idempotent state transitions; non-idempotent retries require
  machine-side idempotency semantics keyed by `invocationId`.

## Streaming and progress

- Machines SHOULD provide structured progress updates during long executions.
- Acceptable channels:
  - SSE stream at `/v1/invoke/{invocationId}/stream`
  - periodic webhook callbacks to `callbackUrl`
- Progress events SHOULD include progress ratio, step text, and machine-local diagnostics.

## Artifact storage expectations

- Machines emit artifacts as stable URIs with immutable content references.
- Artifacts MUST be:
  - tenant-scoped
  - retention-aware (honors workspace policy)
  - hash-verifiable (content-addressable ID preferred)
- Evidence systems should treat machine artifacts as append-only appendage references, not mutable mutable objects.

## Egress controls

- Machines are untrusted runtime inputs/outputs by default.
- They MUST only connect to approved network destinations defined by platform policy.
- Secrets must be injected via controlled secret stores; secrets must not be logged, returned in payloads, or committed to artifacts.

## Validation and observability notes

- Machines should emit explicit machine-facing logs for:
  - start/stop timestamps
  - input/output sizes
  - invocation status transitions
  - error taxonomies
- All exceptions should include machine correlation IDs compatible with control-plane evidence tracing.

## Control-plane endpoints (v1)

Machine invocations are initiated and observed through:

### `POST /v1/workspaces/{workspaceId}/machines/{machineId}/invocations`

Create an invocation:

```json
{
  "schemaVersion": 1,
  "invocationId": "inv-001-4f9",
  "machineId": "machine-poster-1",
  "workspaceId": "ws-1",
  "action": "poster.generate",
  "input": {
    "prompt": "Create a concise changelog summary",
    "targetLength": "short"
  },
  "callbackUrl": "https://control-plane.local/hooks/machine-events"
}
```

Expected 202 response:

```json
{
  "schemaVersion": 1,
  "invocationId": "inv-001-4f9",
  "status": "accepted",
  "statusUrl": "https://control-plane.local/v1/workspaces/ws-1/machines/machine-poster-1/invocations/inv-001-4f9"
}
```

### `GET /v1/workspaces/{workspaceId}/machines/{machineId}/invocations/{invocationId}`

Read invocation status:

```json
{
  "schemaVersion": 1,
  "invocationId": "inv-001-4f9",
  "status": "completed",
  "statusUrl": "https://control-plane.local/v1/workspaces/ws-1/machines/machine-poster-1/invocations/inv-001-4f9",
  "outputArtifactUris": ["s3://artifacts/ws-1/runs/run-9001/poster/summary.md"]
}
```
