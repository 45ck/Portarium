# VaultStaticSecret / VaultDynamicSecret resources for Portarium components.
#
# The Vault Secrets Operator (VSO) syncs these to Kubernetes Secrets, which are
# then consumed by the respective Deployments via envFrom / volumeMounts.
#
# Secret path conventions (Vault KV-v2):
#   portarium/execution-plane/runtime  — adapter credentials, SoR API keys
#   portarium/control-plane/runtime    — DB password, JWT signing key, OIDC secret
#
# Bead: bead-0327

---
# Runtime secrets for the execution-plane (adapter credentials, SoR tokens).
# VSO keeps this in sync; the Deployment references it via secretRef.
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: portarium-execution-plane-runtime
  namespace: portarium
  labels:
    app.kubernetes.io/part-of: portarium
    portarium.io/component: execution-plane
spec:
  vaultAuthRef: portarium-execution-plane
  mount: portarium
  type: kv-v2
  path: execution-plane/runtime
  refreshAfter: 5m
  destination:
    name: portarium-execution-plane-secrets
    create: true
    labels:
      app.kubernetes.io/managed-by: vault-secrets-operator
      app.kubernetes.io/part-of: portarium

---
# Runtime secrets for the control-plane (DB password, signing keys).
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultStaticSecret
metadata:
  name: portarium-control-plane-runtime
  namespace: portarium
  labels:
    app.kubernetes.io/part-of: portarium
    portarium.io/component: control-plane
spec:
  vaultAuthRef: portarium-control-plane
  mount: portarium
  type: kv-v2
  path: control-plane/runtime
  refreshAfter: 5m
  destination:
    name: portarium-control-plane-secrets
    create: true
    labels:
      app.kubernetes.io/managed-by: vault-secrets-operator
      app.kubernetes.io/part-of: portarium

---
# Dynamic DB credentials for the execution-plane via Vault Database secrets engine.
# Short-lived credentials (TTL=1h) reduce blast radius of credential compromise.
apiVersion: secrets.hashicorp.com/v1beta1
kind: VaultDynamicSecret
metadata:
  name: portarium-execution-plane-db
  namespace: portarium
  labels:
    app.kubernetes.io/part-of: portarium
    portarium.io/component: execution-plane
spec:
  vaultAuthRef: portarium-execution-plane
  mount: database
  path: creds/portarium-execution-plane
  renewalPercent: 67
  destination:
    name: portarium-execution-plane-db-creds
    create: true
    labels:
      app.kubernetes.io/managed-by: vault-secrets-operator
      app.kubernetes.io/part-of: portarium
