receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

extensions:
  health_check:
    endpoint: 0.0.0.0:13133

exporters:
  logging:
    verbosity: basic

  # Placeholder for production trace backend (Tempo, Jaeger, etc.).
  # Configure TLS and auth headers for production deployments.
  otlp/tempo:
    endpoint: tempo:4317
    tls:
      insecure: true

  # Placeholder for production metrics backend (Prometheus, Mimir, etc.).
  # Uncomment and configure for production deployments.
  # otlp/prometheus:
  #   endpoint: prometheus:9090
  #   tls:
  #     cert_file: /etc/otelcol-contrib/tls/cert.pem
  #     key_file: /etc/otelcol-contrib/tls/key.pem
  #   headers:
  #     Authorization: "Bearer ${OTEL_EXPORTER_AUTH_TOKEN}"

processors:
  batch:
    timeout: 1s
    send_batch_size: 512
    send_batch_max_size: 1024

  # Memory limiter prevents OOM on high-volume spikes.
  memory_limiter:
    check_interval: 5s
    limit_mib: 256
    spike_limit_mib: 64

  # Redaction processor: obfuscate sensitive tenant/user fields in log attributes.
  # tenantId is hashed rather than removed so traces remain joinable.
  attributes/redact:
    actions:
      - key: tenant.id
        action: hash
      - key: user.email
        action: delete
      - key: user.ip
        action: delete
      - key: http.request.header.authorization
        action: delete
      - key: http.request.header.cookie
        action: delete
      - key: db.statement
        action: delete

  # Resource detection: auto-tag spans with host/container metadata.
  resource:
    attributes:
      - key: service.namespace
        value: portarium
        action: upsert

service:
  extensions:
    - health_check
  pipelines:
    metrics:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - batch
      exporters:
        - logging
    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - attributes/redact
        - resource
        - batch
      exporters:
        - logging
        - otlp/tempo
    logs:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - attributes/redact
        - resource
        - batch
      exporters:
        - logging
