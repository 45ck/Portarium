import fs from 'node:fs';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '..', '..');

const atlasRoot = path.join(repoRoot, 'domain-atlas');
const sourcesRoot = path.join(atlasRoot, 'sources');
const decisionsRoot = path.join(atlasRoot, 'decisions', 'providers');
const indexPath = path.join(repoRoot, 'docs', 'research', 'index.md');

function readJson(filePath) {
  if (!fs.existsSync(filePath)) {
    throw new Error(`Missing file: ${path.relative(repoRoot, filePath)}`);
  }
  return JSON.parse(fs.readFileSync(filePath, 'utf8'));
}

function ensureDir(dirPath) {
  fs.mkdirSync(dirPath, { recursive: true });
}

function escapePipes(value) {
  return String(value).replaceAll('|', '\\|');
}

function relPosix(filePath) {
  return path.relative(repoRoot, filePath).split(path.sep).join('/');
}

function formatPinned(upstream) {
  if (typeof upstream?.commit === 'string' && upstream.commit.trim().length > 0) {
    return upstream.commit.trim().slice(0, 12);
  }
  if (typeof upstream?.version === 'string' && upstream.version.trim().length > 0) {
    const version = upstream.version.trim();
    if (version !== 'pinned-by-commit') return version;
  }
  return 'TBD';
}

function formatPorts(portFamilies) {
  if (!Array.isArray(portFamilies) || portFamilies.length === 0) return '';
  return portFamilies.join(', ');
}

function formatLicense(license) {
  const spdxId = typeof license?.spdxId === 'string' ? license.spdxId.trim() : '';
  const classification =
    typeof license?.classification === 'string' ? license.classification.trim() : 'unknown';

  if (spdxId.length === 0) return classification;
  return `${spdxId} (${classification})`;
}

function main() {
  if (!fs.existsSync(sourcesRoot)) {
    throw new Error(`Missing folder: ${path.relative(repoRoot, sourcesRoot)}`);
  }

  const providerDirs = fs
    .readdirSync(sourcesRoot, { withFileTypes: true })
    .filter((d) => d.isDirectory())
    .map((d) => d.name)
    .sort((a, b) => a.localeCompare(b));

  const rows = [];

  for (const providerDir of providerDirs) {
    const manifestPath = path.join(sourcesRoot, providerDir, 'source.json');
    if (!fs.existsSync(manifestPath)) continue;

    const manifest = readJson(manifestPath);
    const providerId = manifest?.providerId;

    if (typeof providerId !== 'string' || providerId !== providerDir) {
      throw new Error(
        `providerId mismatch: folder "${providerDir}" has providerId "${String(providerId)}"`,
      );
    }

    const providerName =
      typeof manifest?.providerName === 'string' && manifest.providerName.trim().length > 0
        ? manifest.providerName.trim()
        : providerId;

    const ports = formatPorts(manifest?.portFamilies);

    const upstream = manifest?.upstream ?? {};
    const upstreamKind = typeof upstream?.kind === 'string' ? upstream.kind.trim() : '';
    const upstreamRepo = typeof upstream?.repoUrl === 'string' ? upstream.repoUrl.trim() : '';

    const decisionsPath = path.join(decisionsRoot, `${providerId}.md`);
    const decisionsLink = fs.existsSync(decisionsPath) ? `\`${relPosix(decisionsPath)}\`` : '';

    rows.push({
      providerId,
      providerName,
      ports,
      upstream: `${upstreamKind}: ${upstreamRepo}`,
      pinned: formatPinned(upstream),
      license: formatLicense(manifest?.license),
      decisionsLink,
      manifestLink: `\`${relPosix(manifestPath)}\``,
    });
  }

  const lines = [];
  lines.push('<!--');
  lines.push('This file is generated by `npm run domain-atlas:index`.');
  lines.push('Do not edit by hand.');
  lines.push('-->');
  lines.push('');
  lines.push('# Research Index');
  lines.push('');
  lines.push('Single source of truth: `domain-atlas/sources/*/source.json`.');
  lines.push('');
  lines.push('- Upstream clones (gitignored): `domain-atlas/upstreams/`');
  lines.push('- Source intake manifests (committed): `domain-atlas/sources/`');
  lines.push('- Provider decision notes (committed): `domain-atlas/decisions/providers/`');
  lines.push('');
  lines.push('## Sources');
  lines.push('');

  if (rows.length === 0) {
    lines.push('No sources yet. Add `domain-atlas/sources/<provider>/source.json` manifests.');
    lines.push('');
  } else {
    lines.push(
      '| Provider | Name | Port Families | Upstream | Pinned | License | Decisions | Manifest |',
    );
    lines.push('|---|---|---|---|---|---|---|---|');

    for (const row of rows) {
      lines.push(
        `| \`${escapePipes(row.providerId)}\` | ${escapePipes(row.providerName)} | ${escapePipes(row.ports)} | \`${escapePipes(row.upstream)}\` | \`${escapePipes(row.pinned)}\` | \`${escapePipes(row.license)}\` | ${escapePipes(row.decisionsLink)} | ${escapePipes(row.manifestLink)} |`,
      );
    }

    lines.push('');
  }

  ensureDir(path.dirname(indexPath));
  fs.writeFileSync(indexPath, `${lines.join('\n')}\n`, 'utf8');
}

main();
